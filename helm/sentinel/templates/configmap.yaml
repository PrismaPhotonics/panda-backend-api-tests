apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "sentinel.fullname" . }}-config
  labels:
    {{- include "sentinel.labels" . | nindent 4 }}
data:
  sentinel_config.yaml: |
    # Automation Run Sentinel Configuration
    # Generated from Helm values
    
    environment: {{ .Values.config.environment | quote }}
    
    k8s_namespaces:
    {{- range .Values.config.k8s_namespaces }}
      - {{ . | quote }}
    {{- end }}
    
    k8s_label_selectors:
    {{- range $key, $value := .Values.config.k8s_label_selectors }}
      {{ $key }}: {{ $value | quote }}
    {{- end }}
    
    # Log detection rules
    log_detection_rules:
      - pattern: "RUN_START.*pipeline=(?P<pipeline>\\w+).*env=(?P<env>\\w+)"
        pipeline_extractor: "pipeline"
        environment_extractor: "env"
      - pattern: "TEST RUN STARTED.*run_id=(?P<run_id>\\S+)"
        run_id_extractor: "run_id"
    
    # Log patterns
    log_patterns:
      TEST_START: "(?:TEST_START|test.*started|starting test).*?test[=:]\\s*(?P<test_name>[^\\s,]+)"
      TEST_PASS: "(?:TEST_PASS|test.*passed|PASSED).*?test[=:]\\s*(?P<test_name>[^\\s,]+)"
      TEST_FAIL: "(?:TEST_FAIL|test.*failed|FAILED).*?test[=:]\\s*(?P<test_name>[^\\s,]+)"
      TEST_SKIP: "(?:TEST_SKIP|test.*skipped|SKIPPED).*?test[=:]\\s*(?P<test_name>[^\\s,]+)"
      SUITE_START: "(?:SUITE_START|suite.*started|starting suite).*?suite[=:]\\s*(?P<suite_name>[^\\s,]+)"
      SUITE_END: "(?:SUITE_END|suite.*ended|completed suite).*?suite[=:]\\s*(?P<suite_name>[^\\s,]+)"
    
    error_patterns:
      - "\\b(?:error|ERROR|Error)\\b.*"
      - "\\b(?:exception|Exception|EXCEPTION)\\b.*"
      - "\\b(?:failed|FAILED|Failed)\\b.*"
      - "\\b(?:timeout|TIMEOUT|Timeout)\\b.*"
    
    # Pipeline structure rules
    pipeline_structure_rules:
      regression-nightly:
        required_suites:
          - "smoke"
          - "sanity"
          - "regression"
        forbidden_suites:
          - "load"
        required_tags:
          - "@critical"
        expected_test_count:
          min: 200
          max: 400
        required_test_ids: []
      
      smoke:
        required_suites:
          - "smoke"
        expected_test_count:
          min: 20
          max: 80
        required_test_ids: []
      
      load:
        required_suites:
          - "load"
        expected_test_count:
          min: 10
          max: 100
        required_test_ids: []
    
    # Anomaly thresholds
    anomaly_thresholds:
      pod_restart_threshold: 3
      pod_crash_loop_threshold: 2
      test_failure_rate_threshold: 0.5
      test_stuck_threshold_minutes: 30
      error_rate_spike_threshold: 0.2
      test_duration_deviation_threshold: 0.5
    
    alert_cooldown_seconds: {{ .Values.config.alert_cooldown_seconds }}
    
    channels:
    {{- range .Values.config.channels }}
      - type: {{ .type | quote }}
        {{- if .webhook_url }}
        webhook_url: {{ .webhook_url | quote }}
        {{- end }}
        {{- if .to }}
        to:
        {{- range .to }}
          - {{ . | quote }}
        {{- end }}
        {{- end }}
        severity_min: {{ .severity_min | quote }}
        enabled: {{ .enabled }}
    {{- end }}
    
    smtp:
      host: "smtp.example.com"
      port: 587
      user: "${SMTP_USER}"
      password: "${SMTP_PASSWORD}"
      from: "sentinel@example.com"
    
    database:
      type: {{ .Values.config.database.type | quote }}
      path: {{ .Values.config.database.path | quote }}
      {{- if eq .Values.config.database.type "postgresql" }}
      host: "${DB_HOST}"
      port: 5432
      database: "sentinel"
      user: "${DB_USER}"
      password: "${DB_PASSWORD}"
      {{- end }}
    
    api:
      enabled: {{ .Values.config.api.enabled }}
      host: {{ .Values.config.api.host | quote }}
      port: {{ .Values.config.api.port }}
      debug: {{ .Values.config.api.debug }}

