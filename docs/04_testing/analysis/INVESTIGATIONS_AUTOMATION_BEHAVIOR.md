# התנהגות חקירות שנפתחות כחלק מהאוטומציה
# Investigations Automation Behavior Analysis

**תאריך:** 2025-01-27  
**מטרה:** לתעד את ההתנהגות המלאה של חקירות שנפתחות כחלק מהאוטומציה

---

## 📋 סיכום כללי

כאשר האוטומציה יוצרת חקירות, הן עוברות את התהליך הבא:

1. **יצירת Job** → Kubernetes Job נוצר
2. **חיבור ל-gRPC** → הלקוח מתחבר לזרם הנתונים
3. **בדיקת נתונים** → האוטומציה בודקת את הנתונים
4. **ניתוק** → הלקוח מתנתק
5. **ניקוי אוטומטי** → Job נמחק אחרי ~50 שניות

**⚠️ נקודה חשובה:** ה-Job נשאר פתוח במשך ~50 שניות אחרי הניתוק!

---

## 🔄 מחזור החיים של חקירה (Investigation Lifecycle)

### שלב 1: יצירת Job
```
POST /configure → יוצר Kubernetes Job (grpc-job-*)
```

**מה קורה:**
- Focus Server API מקבל בקשה ליצירת job
- יוצר Kubernetes Job בשם `grpc-job-{job_id}-{suffix}`
- Job מתחיל לרוץ ב-Kubernetes
- Job יוצר Pod שמריץ gRPC server
- **זמן:** ~0.3 שניות

**תוצאה:**
- Job קיים ב-Kubernetes
- Pod רץ ב-Kubernetes
- gRPC server מוכן לקבל חיבורים

---

### שלב 2: חיבור ל-gRPC Stream
```
client.connect(stream_url, stream_port)
```

**מה קורה:**
- הלקוח ממתין ל-job להיות ready
- מתחבר ל-gRPC server
- מתחיל לקבל נתונים (stream
- **זמן:** ~12 שניות (בעיית ביצועים!)

**תוצאה:**
- חיבור gRPC פעיל
- נתונים מתחילים לזרום

---

### שלב 3: בדיקת נתונים
```
for frame in client.stream_data():
    check_amplitude_values(frame)
```

**מה קורה:**
- הלקוח מקבל frames מ-gRPC stream
- בודק ערכי amplitude שליליים
- אוסף סטטיסטיקות
- **זמן:** ~6-7 שניות (תלוי במספר frames)

**תוצאה:**
- בדיקה הושלמה
- תוצאות נשמרות

---

### שלב 4: ניתוק
```
client.disconnect()
```

**מה קורה:**
- הלקוח סוגר את ה-gRPC connection
- מנתק מהזstream
- **זמן:** מיידי (~0.1 שניות)

**תוצאה:**
- ✅ gRPC connection נסגר
- ⚠️ **אבל:** ה-Kubernetes Job עדיין רץ!

---

### שלב 5: ניקוי אוטומטי (Cleanup)

**מה קורה:**
- `cleanup-job-$JOB_ID` בודק את ה-CPU כל 10 שניות
- אם CPU ≤ 4m (millicores) במשך 5 בדיקות רצופות → מתחיל cleanup
- Job נמחק מ-Kubernetes
- Pod נמחק

**זמן:**
- 5 בדיקות × 10 שניות = **~50 שניות**

**תוצאה:**
- Job נמחק מ-Kubernetes
- Pod נמחק
- משאבים משוחררים

---

## 📊 התנהגות בטסטים שונים

### 1. Stress Test Loop (`test_investigation_stress_loop.py`)

**מטרה:** לבדוק את המערכת תחת עומס

**התנהגות:**
- יוצר חקירות בלולאה אינסופית
- בודק אם יש יותר מ-**200 חקירות פעילות** → אם כן, עוצר
- יוצר **5 חקירות חדשות** בכל איטרציה
- ממתין ל-gRPC data לכל חקירה
- חוזר ללולאה

**פרמטרים:**
- `MAX_OPEN_INVESTIGATIONS = 200`
- `NEW_INVESTIGATIONS_BATCH = 5`
- `MAX_RETRIES = 3`
- `GRPC_WAIT_TIMEOUT_SECONDS = 30`
- `GRPC_MIN_FRAMES = 5`

**ניקוי:**
- לא מטפל בניקוי מפורש
- מסתמך על ניקוי אוטומטי אחרי 50 שניות

---

### 2. 277 Investigations Test (`run_277_investigations_test.py`)

**מטרה:** לבדוק 277 קונפיגורציות שונות (10% כיסוי)

**התנהגות:**
- יוצר 277 חקירות ברצף
- כל חקירה עם קונפיגורציה שונה
- בודקת negative amplitude values
- בודקת E2E checkpoints (Kubernetes verification)

**פרמטרים:**
- `delay_between_investigations = 5` שניות (ברירת מחדל)
- `max_frames = 500` frames לחקירה

**ניקוי:**
- יש delay של 5 שניות בין חקירות
- מסתמך על ניקוי אוטומטי אחרי 50 שניות
- **הערה:** Jobs נשארים פתוחים ~50 שניות אחרי ניתוק

**העמסה:**
- עם delay של 5 שניות: עד **~5 Jobs במקביל**
- עם delay של 1 שנייה: עד **~13 Jobs במקביל**

---

### 3. 30 Investigations Test (`run_30_investigations_test.py`)

**מטרה:** לבדוק 30 חקירות עם קונפיגורציות משתנות

**התנהגות:**
- יוצר 30 חקירות ברצף
- כל חקירה עם קונפיגורציה שונה
- בודקת negative amplitude values

**פרמטרים:**
- `delay = 2` שניות בין חקירות
- `max_frames = 500` frames לחקירה

**ניקוי:**
- יש delay של 2 שניות בין חקירות
- מסתמך על ניקוי אוטומטי אחרי 50 שניות

---

## ⚠️ בעיות וסיכונים

### 1. Jobs נשארים פתוחים

**הבעיה:**
- אחרי שהלקוח מתנתק, ה-Job נשאר פתוח ~50 שניות
- זה יוצר עומס על Kubernetes
- זה יוצר עומס על Focus Server

**השפעה:**
- עם 277 חקירות ו-delay של 5 שניות: עד 5 Jobs במקביל
- עם 277 חקירות ו-delay של 1 שנייה: עד 13 Jobs במקביל

**פתרון:**
- להגדיל delay בין חקירות (5-10 שניות)
- לנטר מספר Jobs פתוחים
- להשתמש ב-Job cancellation (אם ייושם)

---

### 2. חיבורים איטיים

**הבעיה:**
- חיבור ל-gRPC stream לוקח ~12 שניות
- זה בעיית ביצועים שזוהתה

**השפעה:**
- מגדיל את זמן הריצה הכולל
- יכול לגרום ל-timeouts
- יכול לגרום לכשלונות

**פתרון:**
- לבדוק למה החיבורים איטיים
- לשפר את זמן החיבור
- להוסיף retry logic (כבר קיים)

---

### 3. עומס על המערכת

**הבעיה:**
- מספר Jobs במקביל יוצר עומס על:
  - Kubernetes (Pods, Resources)
  - Focus Server (gRPC servers)
  - MongoDB (רשומות, עדכונים)

**השפעה:**
- עיכובים ביצירת Jobs חדשים
- בעיות ביצועים
- Resource exhaustion

**פתרון:**
- להגדיל delay בין חקירות
- לנטר מספר Jobs פתוחים
- להשתמש ב-batch processing

---

## 💡 המלצות

### 1. הגדלת Delay בין חקירות

**כרגע:**
- Stress Test: אין delay מפורש (רק delay קטן בין איטרציות)
- 277 Investigations: 5 שניות (ברירת מחדל)
- 30 Investigations: 2 שניות

**מומלץ:**
- לפחות 5 שניות בין חקירות
- עדיף 10 שניות לטסטים ארוכים

**יתרונות:**
- נותן זמן ל-Jobs להיסגר
- מפחית עומס על המערכת
- מונע resource exhaustion

---

### 2. ניטור מספר Jobs פתוחים

**מומלץ:**
- לבדוק כמה Jobs פתוחים לפני יצירת חדש
- אם יש יותר מ-N Jobs (למשל, 5), להמתין
- להוסיף logging של מספר Jobs פתוחים

**יתרונות:**
- שליטה טובה יותר על העומס
- מונע עומס יתר
- מתאים את עצמו למצב המערכת

---

### 3. Batch Processing

**מומלץ:**
- לחלק חקירות לקבוצות של 10-20
- להריץ כל קבוצה, לחכות שה-Jobs ייסגרו, ואז להמשיך

**יתרונות:**
- שליטה טובה יותר על העומס
- מונע עומס יתר
- מתאים לטסטים ארוכים

---

### 4. Job Cancellation (אם ייושם)

**מומלץ:**
- להשתמש ב-`DELETE /job/{job_id}` כדי לסגור Jobs מפורשות
- **אבל:** כרגע לא מיושם (מחזיר 404)

**יתרונות:**
- שליטה מלאה על Jobs
- ניקוי מיידי
- מפחית עומס

---

## 📊 טבלת השוואה

| פרמטר | Stress Test | 277 Investigations | 30 Investigations |
|--------|-------------|-------------------|-------------------|
| **מספר חקירות** | עד 200 | 277 | 30 |
| **Delay בין חקירות** | 1 שנייה | 5 שניות | 2 שניות |
| **Jobs במקביל** | עד 13 | עד 5 | עד 2 |
| **זמן כולל** | עד 200 איטרציות | ~110 דקות | ~10 דקות |
| **ניקוי** | אוטומטי (50s) | אוטומטי (50s) | אוטומטי (50s) |

---

## ✅ מסקנות

1. **חקירות נשארות פתוחות ~50 שניות** אחרי ניתוק
2. **יש delay בין חקירות** כדי להפחית עומס
3. **ניקוי אוטומטי** קורה אחרי 50 שניות של CPU נמוך
4. **מומלץ להגדיל delay** לפחות 5 שניות בין חקירות
5. **מומלץ לנטר** מספר Jobs פתוחים במהלך הריצה

---

## 🔧 שינויים מומלצים

1. **הגדלת Delay מ-1 ל-5 שניות** (מינימום)
2. **הוספת Logging של מספר Jobs פתוחים** (לניטור)
3. **הוספת אפשרות להגדיר Delay מהקונסול** (`--delay-between-investigations`)
4. **הוספת ניטור Jobs פתוחים** לפני יצירת חדש
5. **שיפור זמן החיבור** ל-gRPC stream (מ-12 שניות)

---

## 📚 קבצים קשורים

- `be_focus_server_tests/stress/test_investigation_stress_loop.py` - Stress test loop
- `scripts/run_277_investigations_test.py` - 277 investigations test
- `scripts/run_30_investigations_test.py` - 30 investigations test
- `docs/04_testing/analysis/277_INVESTIGATIONS_LOAD_ANALYSIS.md` - Load analysis
- `docs/07_infrastructure/JOB_DELETION_TIMELINE.md` - Job deletion timeline
- `docs/07_infrastructure/GRPC_JOB_LIFECYCLE.md` - gRPC job lifecycle

