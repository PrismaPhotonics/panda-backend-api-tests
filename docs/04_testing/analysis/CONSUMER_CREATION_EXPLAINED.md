# ×”×¡×‘×¨: ××™ ××™×™×¦×¨ ××ª ×”-Job ×•××” ×”×˜×¡×˜ ×‘×•×“×§
## Explanation: Who Creates the Job and What the Test Checks

**×ª××¨×™×š:** 2025-11-13  
**××˜×¨×”:** ×œ×”×‘×™×Ÿ ××ª ×”×ª×”×œ×™×š ×”××œ× ×©×œ ×™×¦×™×¨×ª Job ×•-Consumer

---

## ğŸ”„ ×ª×”×œ×™×š ×™×¦×™×¨×ª Job - Flow ××œ×

### ×©×œ×‘ 1: ×”×˜×¡×˜ ×©×•×œ×— ×‘×§×©×” ×œ-Backend

```python
# ×”×˜×¡×˜ ×™×•×¦×¨ payload
payload = {
    "displayTimeAxisDuration": 10,
    "nfftSelection": 1024,
    "channels": {"min": 1, "max": 50},
    "frequencyRange": {"min": 0, "max": 500},
    "view_type": ViewType.MULTICHANNEL
}

# ×™×•×¦×¨ ConfigureRequest object
config_request = ConfigureRequest(**payload)

# ×©×•×œ×— ×œ-backend
response = focus_server_api.configure_streaming_job(config_request)
```

**××” ×§×•×¨×” ×›××Ÿ:**
- ×”×˜×¡×˜ ×©×•×œ×— `POST https://10.10.10.100/focus-server/configure`
- ×”-backend ××§×‘×œ ××ª ×”×‘×§×©×”

---

### ×©×œ×‘ 2: ×”-Backend ××™×™×¦×¨ ××ª ×”-Job

**××™ ××™×™×¦×¨ ××ª ×”-Job?**
- **×”-Backend (Focus Server)** ××™×™×¦×¨ ××ª ×”-Job

**××” ×”-Backend ×¢×•×©×”:**
1. **×•×œ×™×“×¦×™×”** - ×‘×•×“×§ ×©×”×§×•× ×¤×™×’×•×¨×¦×™×” ×ª×§×™× ×”
2. **×™×¦×™×¨×ª Job ID** - ××™×™×¦×¨ ××–×”×” ×™×™×—×•×“×™ (×œ××©×œ: `"18-3"`)
3. **×©××™×¨×” ×‘-MongoDB** - ×©×•××¨ ××ª ×”-Job ×‘××¡×“ ×”× ×ª×•× ×™×
4. **×”×¤×¢×œ×ª Baby Analyzer** - ×™×•×¦×¨ Kubernetes Pod ×©××¢×‘×“ ××ª ×”× ×ª×•× ×™×
5. **×”×’×“×¨×ª RabbitMQ** - ×™×•×¦×¨ Queue ×¢×‘×•×¨ ×”-Job
6. **×”×—×–×¨×ª Response** - ××—×–×™×¨ ××ª ×”-Job ID ×œ×œ×§×•×—

**Response ××”-Backend:**
```json
{
  "job_id": "18-3",
  "status": "configured",
  "stream_url": "10.10.10.100",
  "stream_port": 50051
}
```

---

### ×©×œ×‘ 3: ×”×˜×¡×˜ ××§×‘×œ ××ª ×”-Job ID

```python
# ×”×˜×¡×˜ ××§×‘×œ ××ª ×”-response
response = focus_server_api.configure_streaming_job(config_request)

# ××—×œ×¥ ××ª ×”-job_id
job_id = response.job_id  # "18-3"
```

**××” ×™×© ×œ× ×• ×¢×›×©×™×•:**
- âœ… Job × ×•×¦×¨ ×‘-Backend
- âœ… ×™×© ×œ× ×• Job ID
- âŒ **××‘×œ ×”-Consumer ×¢×“×™×™×Ÿ ×œ× × ×•×¦×¨!**

---

## ğŸ¤” ××” ×–×” Consumer?

**Consumer** = ×—×œ×§ ×‘-Backend ×©×××–×™×Ÿ ×œ-RabbitMQ ×•××¢×‘×“ ××ª ×”× ×ª×•× ×™×

**×œ××” ×¦×¨×™×š Consumer?**
- ×”-Baby Analyzer ×©×•×œ×— × ×ª×•× ×™× ×œ-RabbitMQ
- ×”-Consumer ×¦×¨×™×š ×œ×”××–×™×Ÿ ×œ-Queue ×•×œ×¢×‘×“ ××ª ×”× ×ª×•× ×™×
- ×¨×§ ××—×¨×™ ×©×”-Consumer × ×•×¦×¨, ××¤×©×¨ ×œ×§×‘×œ metadata ×•-waterfall data

**××ª×™ ×”-Consumer × ×•×¦×¨?**
- **×œ× ××™×“!** ×–×” ×ª×”×œ×™×š ××¡×™× ×›×¨×•× ×™
- ×”-Backend ×¦×¨×™×š:
  1. ×œ×™×¦×•×¨ ××ª ×”-Job
  2. ×œ×”×¤×¢×™×œ ××ª ×”-Baby Analyzer
  3. ×œ×”×’×“×™×¨ ××ª ×”-RabbitMQ Queue
  4. **×¨×§ ××–** ×œ×™×¦×•×¨ ××ª ×”-Consumer

**×–××Ÿ ×™×¦×™×¨×”:** ×‘×“×¨×š ×›×œ×œ 1-5 ×©× ×™×•×ª, ××‘×œ ×™×›×•×œ ×œ×§×—×ª ×¢×“ 30 ×©× ×™×•×ª

---

## ğŸ§ª ××” ×”×˜×¡×˜ ×‘×•×“×§?

### ×”××˜×¨×” ×©×œ ×”×˜×¡×˜

**`test_consumer_creation_timing`** ×‘×•×“×§:
1. **×›××” ×–××Ÿ ×œ×•×§×— ×œ-Consumer ×œ×”×™×•×•×¦×¨** ××—×¨×™ ×©×”-Job × ×•×¦×¨
2. **×”×× ×”-Consumer × ×•×¦×¨ ×‘×›×œ×œ** ×ª×•×š ×–××Ÿ ×¡×‘×™×¨

### ××™×š ×”×˜×¡×˜ ×¢×•×‘×“?

```python
# ×©×œ×‘ 1: ×™×•×¦×¨ Job
response = focus_server_api.configure_streaming_job(config_request)
job_id = response.job_id  # "18-3"

# ×©×œ×‘ 2: ××—×›×” ×œ-Consumer
# ×”×˜×¡×˜ ×× ×¡×” ×œ×§×‘×œ metadata ×›×œ 100ms
# ×× ×”-Consumer ×§×™×™×, ×”-metadata endpoint ×™×—×–×™×¨ × ×ª×•× ×™×
# ×× ×œ×, ×™×—×–×™×¨ 404 "Invalid job_id"

while time.time() - poll_start < 30:  # ××—×›×” ×¢×“ 30 ×©× ×™×•×ª
    try:
        # ×× ×¡×” ×œ×§×‘×œ metadata
        metadata = focus_server_api.get_job_metadata(job_id)
        
        # ×× ×”×’×¢× ×• ×œ×›××Ÿ, ×”-Consumer ×§×™×™×! âœ…
        consumer_ready = True
        break
        
    except APIError as e:
        # 404 = Consumer ×¢×“×™×™×Ÿ ×œ× ×§×™×™×
        if "404" in str(e) or "Invalid job_id" in str(e):
            # ×××©×™×š ×œ×—×›×•×ª...
            time.sleep(0.1)  # 100ms
```

### ×œ××” ×”×˜×¡×˜ × ×›×©×œ?

**×”×˜×¡×˜ × ×›×©×œ ×›×™:**
1. ×”-Job × ×•×¦×¨ ××™×“ (××§×‘×œ×™× `job_id = "18-3"`)
2. ××‘×œ ×”-Consumer ×œ× × ×•×¦×¨ ××™×“
3. ×”×˜×¡×˜ ×× ×¡×” ×œ×§×‘×œ metadata ××™×“ ××—×¨×™ ×”-configure
4. ×”-Backend ××—×–×™×¨ `404 "Invalid job_id"` ×›×™ ×”-Consumer ×¢×“×™×™×Ÿ ×œ× ×§×™×™×
5. ×”×˜×¡×˜ ××—×›×” 10 ×©× ×™×•×ª (×¢×›×©×™×• 30 ×©× ×™×•×ª ××—×¨×™ ×”×ª×™×§×•×Ÿ)
6. ×× ×”-Consumer ×œ× × ×•×¦×¨ ×ª×•×š ×”×–××Ÿ ×”×–×”, ×”×˜×¡×˜ × ×›×©×œ

---

## ğŸ“Š ×ª×¨×©×™× ×–×¨×™××”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ×”×˜×¡×˜ ×©×•×œ×— POST /configure                                â”‚
â”‚    â†“                                                         â”‚
â”‚ 2. Backend ××™×™×¦×¨ Job                                        â”‚
â”‚    â”œâ”€ ×™×•×¦×¨ Job ID: "18-3"                                   â”‚
â”‚    â”œâ”€ ×©×•××¨ ×‘-MongoDB                                        â”‚
â”‚    â”œâ”€ ××¤×¢×™×œ Baby Analyzer                                   â”‚
â”‚    â””â”€ ××—×–×™×¨ Response ×¢× job_id                              â”‚
â”‚    â†“                                                         â”‚
â”‚ 3. ×”×˜×¡×˜ ××§×‘×œ job_id = "18-3"                               â”‚
â”‚    â†“                                                         â”‚
â”‚ 4. ×”×˜×¡×˜ ×× ×¡×” ×œ×§×‘×œ metadata (GET /metadata/18-3)           â”‚
â”‚    â†“                                                         â”‚
â”‚ 5. Backend ×‘×•×“×§: ×”×× Consumer ×§×™×™×?                        â”‚
â”‚    â”œâ”€ âŒ ×œ× ×§×™×™× â†’ ××—×–×™×¨ 404 "Invalid job_id"              â”‚
â”‚    â””â”€ âœ… ×§×™×™× â†’ ××—×–×™×¨ metadata                              â”‚
â”‚    â†“                                                         â”‚
â”‚ 6. ×× Consumer ×œ× ×§×™×™×, ×”×˜×¡×˜ ××—×›×” 100ms ×•×× ×¡×” ×©×•×‘          â”‚
â”‚    â†“                                                         â”‚
â”‚ 7. ×—×•×–×¨ ×œ×©×œ×‘ 4 (×¢×“ 30 ×©× ×™×•×ª)                              â”‚
â”‚    â†“                                                         â”‚
â”‚ 8. ×× Consumer × ×•×¦×¨ â†’ ×”×˜×¡×˜ ×¢×•×‘×¨ âœ…                          â”‚
â”‚    ×× ×œ× â†’ ×”×˜×¡×˜ × ×›×©×œ âŒ                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ×œ××” ×”-Consumer ×œ× × ×•×¦×¨ ××™×“?

**×¡×™×‘×•×ª ××¤×©×¨×™×•×ª:**
1. **×ª×”×œ×™×š ××¡×™× ×›×¨×•× ×™** - ×”-Backend ×¦×¨×™×š ×œ×”×¤×¢×™×œ ×›××” ×ª×”×œ×™×›×™×
2. **Kubernetes Pod** - ×¦×¨×™×š ×–××Ÿ ×œ×”×¤×¢×™×œ ××ª ×”-Pod
3. **RabbitMQ** - ×¦×¨×™×š ×–××Ÿ ×œ×”×’×“×™×¨ ××ª ×”-Queue
4. **×¨×©×ª** - ×™×›×•×œ ×œ×”×™×•×ª ×¢×™×›×•×‘ ×‘×¨×©×ª
5. **×¢×•××¡** - ×× ×™×© ×”×¨×‘×” Jobs, ×–×” ×™×›×•×œ ×œ×§×—×ª ×™×•×ª×¨ ×–××Ÿ

---

## âœ… ××” ×”×˜×¡×˜ ×‘×•×“×§ ×‘×¡×•×¤×• ×©×œ ×“×‘×¨?

1. **×©×”×ª×”×œ×™×š ×¢×•×‘×“** - ×©×”-Job × ×•×¦×¨ ×‘×”×¦×œ×—×”
2. **×©×”×–××Ÿ ×¡×‘×™×¨** - ×©×”-Consumer × ×•×¦×¨ ×ª×•×š ×–××Ÿ ×¡×‘×™×¨ (×¢×“ 30 ×©× ×™×•×ª)
3. **×©×”××¢×¨×›×ª ×™×¦×™×‘×”** - ×©×”-Backend ×™×›×•×œ ×œ×™×¦×•×¨ Consumers ×‘×¦×•×¨×” ×¢×§×‘×™×ª

---

## ğŸ“ ×¡×™×›×•×

| ×©×œ×‘ | ××™ ×¢×•×©×” | ××” ×§×•×¨×” | ×–××Ÿ |
|-----|---------|---------|-----|
| 1. Configure | **Backend** | ×™×•×¦×¨ Job ID | ××™×“ (~0.2s) |
| 2. Job Creation | **Backend** | ×©×•××¨ ×‘-MongoDB | ××™×“ (~0.1s) |
| 3. Baby Analyzer | **Backend** | ××¤×¢×™×œ Kubernetes Pod | 1-5 ×©× ×™×•×ª |
| 4. RabbitMQ Setup | **Backend** | ×™×•×¦×¨ Queue | 1-2 ×©× ×™×•×ª |
| 5. **Consumer Creation** | **Backend** | ×™×•×¦×¨ Consumer | **1-30 ×©× ×™×•×ª** |
| 6. Metadata Available | **Backend** | Consumer ××•×›×Ÿ | ××—×¨×™ ×©×œ×‘ 5 |

**×”×˜×¡×˜ ×‘×•×“×§:** ×”×× ×©×œ×‘ 5 ×§×•×¨×” ×ª×•×š ×–××Ÿ ×¡×‘×™×¨ (30 ×©× ×™×•×ª)

---

**××—×‘×¨:** AI Assistant  
**×ª××¨×™×š:** 2025-11-13

