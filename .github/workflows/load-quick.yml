name: Quick Load

on:
  workflow_dispatch:
    inputs:
      concurrent_requests:
        description: "Number of concurrent requests"
        default: "50"
        type: string
      duration_seconds:
        description: "Test duration in seconds"
        default: "60"
        type: string
  pull_request:
    branches: [main]
    paths:
      - 'be_focus_server_tests/load/**'
      - 'be_focus_server_tests/integration/load/**'
      - 'src/apis/**'

env:
  PYTHON_VERSION: '3.13'

jobs:
  quick-load:
    # Use self-hosted Windows runner for production environment access
    runs-on: [self-hosted, windows, "panda_automation"]
    timeout-minutes: 15  # Hard limit - never exceed 15 minutes

    env:
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.100' }}
      FOCUS_API_PREFIX: ${{ secrets.FOCUS_API_PREFIX || '/focus-server' }}
      VERIFY_SSL: 'false'
      ENVIRONMENT: 'staging'
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1
      # Quick test settings - override defaults
      LOAD_TEST_CONCURRENT_REQUESTS: ${{ inputs.concurrent_requests || '50' }}
      LOAD_TEST_DURATION_SECONDS: ${{ inputs.duration_seconds || '60' }}
      QUICK_LOAD_MODE: 'true'  # Flag for tests to use quick settings

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (Quick)
        shell: powershell
        run: |
          # Quick Python setup - try py launcher first
          $pythonCmd = $null
          if ((py --version 2>&1) -match "Python") {
            $pythonCmd = "py"
          } elseif ((python --version 2>&1) -match "Python") {
            $pythonCmd = "python"
          } else {
            Write-Host "::error::Python not found"
            exit 1
          }
          Write-Host "Using Python: $pythonCmd"
          echo "PYTHON_CMD=$pythonCmd" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Install dependencies (cached)
        shell: powershell
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\install_dependencies.ps1
          & $env:PYTHON_CMD -m pip install -e . --quiet

      - name: Quick server check
        shell: powershell
        run: |
          $url = "https://$env:FOCUS_SERVER_HOST$env:FOCUS_API_PREFIX/ack"
          Write-Host "Checking server: $url"
          $result = curl.exe -k -s -w "%{http_code}" -o nul $url 2>&1
          if ($result -ne "200") {
            Write-Host "::error::Server not reachable (HTTP $result)"
            exit 1
          }
          Write-Host "Server OK (HTTP 200)"

      - name: Run Quick Load Tests
        id: load-tests
        continue-on-error: true  # Don't fail pipeline - report results instead
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          Write-Host "========================================"
          Write-Host "QUICK LOAD TEST SUITE"
          Write-Host "========================================"
          Write-Host "Target: https://$env:FOCUS_SERVER_HOST$env:FOCUS_API_PREFIX"
          Write-Host "Concurrent requests: $env:LOAD_TEST_CONCURRENT_REQUESTS"
          Write-Host "Duration: $env:LOAD_TEST_DURATION_SECONDS seconds"
          Write-Host "Quick mode: $env:QUICK_LOAD_MODE"
          Write-Host "========================================"
          
          # Run ONLY the quick load tests (marked with @pytest.mark.quick_load)
          # --capture=no ensures print statements are visible in CI
          $xmlFile = "reports/junit-quick-load.xml"
          $exitCode = 1  # Default to failure
          
          try {
          & $env:PYTHON_CMD -m pytest `
            be_focus_server_tests/load/test_quick_load_metrics.py `
            -m "quick_load" `
            --env staging `
            --skip-health-check `
            -v `
            --tb=long `
            --capture=no `
            --log-cli-level=INFO `
              --junitxml=$xmlFile `
            --json-report `
              --json-report-file=reports/quick-load-metrics.json 2>&1 | Tee-Object -Variable pytestOutput
            
            $pytestOutput
          
          $exitCode = $LASTEXITCODE
            Write-Host "Pytest exit code: $exitCode"
          } catch {
            Write-Host "::error::Pytest execution failed: $_"
            $exitCode = 1
          } finally {
            # Always ensure XML file exists (create empty one if pytest failed before creating it)
            if (-not (Test-Path $xmlFile)) {
              Write-Host "::warning::No XML file created - creating empty one to indicate failure"
              $emptyXml = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="quick-load" tests="0" failures="0" errors="1" skipped="0" time="0"><testcase name="pytest_execution_failed" classname="pytest"><error message="Pytest failed before tests could run (possibly health check or collection error)" type="ExecutionError">Pytest failed before tests could run</error></testcase></testsuite>'
              $emptyXml | Out-File -FilePath $xmlFile -Encoding utf8 -Force
              Write-Host "Created empty XML file: $xmlFile"
            } else {
              Write-Host "XML file exists: $xmlFile"
            }
            
            # Store exit code for later checking
            echo "EXIT_CODE=$exitCode" | Out-File -FilePath "reports/quick-load-exit-code.txt" -Encoding utf8 -Force
          }
          
          # Show test summary even on failure
          if (Test-Path $xmlFile) {
            Write-Host "========================================"
            Write-Host "TEST RESULTS SUMMARY"
            Write-Host "========================================"
            $xml = [xml](Get-Content $xmlFile)
            # Handle both testsuite (single) and testsuites (wrapper) formats
            $testsuite = if ($xml.testsuites) { $xml.testsuites.testsuite } else { $xml.testsuite }
            if ($testsuite) {
              Write-Host "Tests: $($testsuite.tests)"
              Write-Host "Failures: $($testsuite.failures)"
              Write-Host "Errors: $($testsuite.errors)"
              Write-Host "Time: $([math]::Round([double]$testsuite.time, 1))s"
            } else {
              Write-Host "Could not parse JUnit XML"
            }
            Write-Host "========================================"
          }
          
          exit $exitCode

      - name: Generate Metrics Report
        if: always()
        shell: powershell
        run: |
          Write-Host "Generating load test report..."
          
          # Always generate report (script handles missing file gracefully)
          & $env:PYTHON_CMD scripts/generate_load_metrics_report.py `
            reports/quick-load-metrics.json `
            --output reports/load-metrics-summary.md
          
          # Output to GitHub Summary
          if (Test-Path "reports/load-metrics-summary.md") {
            Write-Host "Adding report to GitHub Summary..."
            Get-Content reports/load-metrics-summary.md | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            Write-Host "Report added to summary!"
          } else {
            # Generate minimal summary if no report
            $fallback = "# Quick Load Tests Report`n`nReport generation failed. Check test logs."
            $fallback | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }

      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quick-load-reports
          path: reports/
          retention-days: 7
          if-no-files-found: warn

