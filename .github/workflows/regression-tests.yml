name: Regression Tests (Nightly)

on:
  schedule:
    # Run every night at 23:00 UTC (01:00 Israel time)
    - cron: '0 23 * * *'
  workflow_dispatch:
    # Manual trigger only - NOT part of regular CI

jobs:
  regression-tests:
    name: Nightly Regression Tests
    runs-on: [self-hosted, windows, "panda_automation"]
    permissions:
      checks: write
      pull-requests: write
      contents: read
    timeout-minutes: 240  # 4 hours for comprehensive nightly tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check VPN Connection
        shell: powershell
        run: |
          Write-Host "========================================"
          Write-Host "Checking VPN Connection"
          Write-Host "========================================"
          
          # Check if we can reach the Focus Server (internal network)
          $focusServerIP = "10.10.10.100"
          Write-Host "Testing connectivity to Focus Server ($focusServerIP)..."
          
          $pingResult = Test-Connection -ComputerName $focusServerIP -Count 2 -Quiet -ErrorAction SilentlyContinue
          
          if ($pingResult) {
            Write-Host "[OK] VPN is connected - can reach internal network"
          } else {
            Write-Host "[WARNING] Cannot ping Focus Server directly, trying HTTP..."
            
            # Try HTTP as backup (some VPNs block ICMP)
            $httpResult = curl.exe -k -s -w "%{http_code}" -o nul "https://$focusServerIP/focus-server/ack" 2>&1
            
            if ($httpResult -eq "200") {
              Write-Host "[OK] VPN is connected - Focus Server responding on HTTPS"
            } else {
              Write-Host "::error::VPN NOT CONNECTED - Cannot reach internal network!"
              Write-Host "HTTP status: $httpResult"
              Write-Host ""
              Write-Host "Please ensure:"
              Write-Host "  1. VPN client is running on the self-hosted runner"
              Write-Host "  2. VPN is connected to the internal network"
              Write-Host "  3. Focus Server (10.10.10.100) is accessible"
              exit 1
            }
          }
          
          Write-Host "========================================"

      - name: Set up Python
        shell: powershell
        run: |
          $ErrorActionPreference = 'Continue'
          $pythonVersion = py --version 2>&1 | Select-String -Pattern "Python (\d+\.\d+)" | ForEach-Object { $_.Matches[0].Groups[1].Value }
          if ($pythonVersion) {
            Write-Host "Found Python $pythonVersion via py launcher"
            $pythonPath = py -c "import sys; print(sys.executable)" 2>&1
            if ($pythonPath -and -not ($pythonPath -match "Error|Exception")) {
              $pythonDir = Split-Path $pythonPath
              $scriptsDir = Join-Path $pythonDir "Scripts"
              
              if ($env:GITHUB_PATH) {
                echo "$pythonDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                echo "$scriptsDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
              }
              
              Write-Host "Python path: $pythonPath"
              Write-Host "Scripts path: $scriptsDir"
            } else {
              Write-Host "Warning: Could not get Python path, but py launcher works"
            }
          } else {
            Write-Host "Python not found via py launcher, trying python directly..."
            $pythonPaths = @(
              "C:\Python*",
              "C:\Program Files\Python*",
              "C:\Users\$env:USERNAME\AppData\Local\Programs\Python\Python*"
            )
            foreach ($pathPattern in $pythonPaths) {
              $foundPython = Get-ChildItem -Path $pathPattern -Filter "python.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($foundPython) {
                $pythonDir = Split-Path $foundPython.FullName
                $scriptsDir = Join-Path $pythonDir "Scripts"
                
                if ($env:GITHUB_PATH) {
                  echo "$pythonDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                  echo "$scriptsDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                }
                
                Write-Host "Found Python at: $($foundPython.FullName)"
                break
              }
            }
          }
          Write-Host "Verifying Python access:"
          py --version
          $pipResult = py -m pip --version 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Warning: pip not accessible via py -m pip, but continuing..."
            Write-Host "pip output: $pipResult"
          } else {
            Write-Host "pip is accessible"
          }

      - name: Install deps
        shell: powershell
        run: |
          py -m ensurepip --upgrade
          py -m pip install --upgrade pip
          if (Test-Path requirements.txt) {
            py -m pip install -r requirements.txt
          }
          py -m pip install pytest pytest-cov requests

      - name: Install project in editable mode
        shell: powershell
        run: |
          Write-Host "Installing project in editable mode..."
          py -m pip install -e .
          if ($LASTEXITCODE -ne 0) {
            Write-Host "::warning::Failed to install project in editable mode, continuing anyway..."
          } else {
            Write-Host "Project installed successfully"
          }

      - name: Verify Python and pytest installation
        shell: powershell
        run: |
          where.exe py
          py --version
          py -c "import pytest; print(f'pytest {pytest.__version__}')"

      - name: Run regression tests
        shell: powershell
        continue-on-error: true
        run: |
          if (-not (Test-Path test-results)) {
            New-Item -ItemType Directory -Path test-results | Out-Null
          }
          
          Write-Host "========================================"
          Write-Host "NIGHTLY REGRESSION TEST SUITE"
          Write-Host "========================================"
          Write-Host "Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Host "Includes: All tests except UI, slow, nightly, load, stress"
          Write-Host "========================================"
          
          py -m pytest be_focus_server_tests/ `
            -m "not slow and not nightly and not load and not stress and not gradual_load" `
            --ignore=be_focus_server_tests/ui `
            --ignore=be_focus_server_tests/load `
            --ignore=be_focus_server_tests/stress `
            -v `
            --junitxml=test-results\junit-regression.xml `
            --cov=be_focus_server_tests `
            --cov-report=term-missing

      - name: List test result files
        shell: powershell
        if: always()
        run: |
          Write-Host "Checking for test result files:"
          if (Test-Path test-results\*.xml) {
            Write-Host "Files found!"
            Get-ChildItem test-results\*.xml | ForEach-Object { Write-Host "Found: $($_.FullName)" }
          } else {
            Write-Host "No XML files found in test-results"
          }

      - name: Publish Test Results
        id: test-reporter
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Pytest Results
          path: test-results/junit-*.xml
          path-replace-backslashes: true
          reporter: java-junit
          list-suites: all
          list-tests: all
          max-annotations: 50
          fail-on-error: false
          only-summary: false
          working-directory: ${{ github.workspace }}

      - name: Get Check Run ID
        id: get-check-run
        if: always()
        shell: powershell
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Getting check run ID for 'Pytest Results'..."
          $checkRunId = py -c "import requests, json, os, time; repo = os.environ['GITHUB_REPOSITORY']; sha = os.environ.get('GITHUB_SHA', ''); token = os.environ['GITHUB_TOKEN']; headers = {'Authorization': f'Bearer {token}', 'Accept': 'application/vnd.github.v3+json'}; time.sleep(3); url = f'https://api.github.com/repos/{repo}/commits/{sha}/check-runs'; params = {'check_name': 'Pytest Results', 'filter': 'latest'}; r = requests.get(url, headers=headers, params=params); data = r.json(); check_runs = data.get('check_runs', []); check_run_id = str(check_runs[0].get('id', '')) if check_runs else ''; print(check_run_id)" 2>&1
          if ($LASTEXITCODE -eq 0 -and $checkRunId) {
            Write-Host "CHECK_RUN_ID=$checkRunId"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "id=$checkRunId"
          } else {
            Write-Host "CHECK_RUN_ID="
            Add-Content -Path $env:GITHUB_OUTPUT -Value "id="
          }

      - name: Parse and Display Test Results
        if: always()
        shell: powershell
        env:
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          CHECK_RUN_ID: ${{ steps.get-check-run.outputs.id }}
        run: |
          py parse_junit_results.py

      - uses: actions/upload-artifact@v4
        with:
          name: junit-reports
          path: test-results\*.xml
          if-no-files-found: warn
