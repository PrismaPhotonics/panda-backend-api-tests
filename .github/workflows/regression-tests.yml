name: Regression Tests

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every night at 23:00 UTC
    - cron: '0 23 * * *'
  workflow_dispatch:
    inputs:
      require_server:
        description: "Fail if Focus server is unreachable"
        default: "true"
        type: choice
        options: [ "true", "false" ]

env:
  PYTHON_VERSION: '3.12'

jobs:
  regression:
    # IMPORTANT: Use self-hosted Windows runner for production environment access
    # Cloud runners cannot access internal network (10.10.10.100)
    runs-on: [self-hosted, Windows]
    timeout-minutes: 60

    env:
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.100' }}
      FOCUS_SERVER_PORT: ${{ secrets.FOCUS_SERVER_PORT || '' }}
      FOCUS_API_PREFIX: ${{ secrets.FOCUS_API_PREFIX || '/focus-server' }}
      VERIFY_SSL: ${{ secrets.VERIFY_SSL || 'false' }}
      REQUIRE_SERVER: ${{ inputs.require_server || secrets.REQUIRE_SERVER || 'true' }}
      ENVIRONMENT: ${{ secrets.ENVIRONMENT || 'new_production' }}
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        shell: powershell
        run: |
          python -m pip install -U pip setuptools wheel
          
          Write-Host "Installing dependencies..."
          
          # Install core testing framework (pytest 9.0.1 first)
          pip install --no-cache-dir --prefer-binary `
            pytest==9.0.1 pytest-asyncio pytest-timeout pytest-mock pytest-html pytest-cov pytest-json-report pytest-xdist
          
          # Install HTTP and data processing
          pip install --no-cache-dir --prefer-binary `
            requests httpx beautifulsoup4 pydantic pydantic-settings orjson pyyaml
          
          # Install infrastructure packages
          pip install --no-cache-dir --prefer-binary `
            kubernetes pymongo paramiko pika structlog colorlog python-dateutil pytz psutil python-dotenv netaddr
          
          # Install optional packages
          pip install --no-cache-dir --prefer-binary `
            allure-pytest jinja2 asyncio-mqtt aiofiles || echo "Some optional packages failed"
          
          Write-Host "Dependency installation completed!"
          pip list | Select-Object -First 40

      - name: Preflight – check Focus availability
        id: preflight
        shell: powershell
        continue-on-error: true
        run: |
          # Initialize outputs with defaults
          echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          echo "status=000" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          # Build base URL
          $BASE = "https://$env:FOCUS_SERVER_HOST$env:FOCUS_API_PREFIX"
          Write-Host "Checking $BASE/channels"
          Write-Host "FOCUS_SERVER_HOST: $env:FOCUS_SERVER_HOST"
          Write-Host "FOCUS_SERVER_PORT: $($env:FOCUS_SERVER_PORT -replace '^$', '(not used - HTTPS default)')"
          Write-Host "REQUIRE_SERVER: $env:REQUIRE_SERVER"
          Write-Host ""
          Write-Host "Network diagnostics:"
          Write-Host "  Hostname: $env:COMPUTERNAME"
          Write-Host "  User: $env:USERNAME"
          Write-Host ""
          Write-Host "Testing HTTP connection:"
          Write-Host "  URL: $BASE/channels"
          
          try {
            # Try Invoke-WebRequest with increased timeout
            $response = Invoke-WebRequest -Uri "$BASE/channels" -Method Get -SkipCertificateCheck -TimeoutSec 30 -ErrorAction Stop
            $code = $response.StatusCode
            
            if ($code -ge 200 -and $code -lt 400) {
              Write-Host "  ✓ HTTP request succeeded with HTTP $code"
              Write-Host "  Response: $($response.Content.Substring(0, [Math]::Min(100, $response.Content.Length)))"
              echo "reachable=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              Write-Host "✓ Focus server is reachable"
            } else {
              echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              Write-Host "✗ Focus server unreachable (HTTP $code)"
            }
          } catch {
            $code = "000"
            echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            Write-Host "✗ Focus server unreachable (Connection failed)"
            Write-Host "  Error: $($_.Exception.Message)"
            
            if ($env:REQUIRE_SERVER -eq "true") {
              Write-Host "::error::Focus server unreachable. Server must be accessible for regression tests."
            }
          }
          
          Write-Host ""
          Write-Host "Final HTTP status code: $code"

      - name: Run regression tests
        shell: powershell
        run: |
          $FOCUS_URL = "$env:FOCUS_SERVER_HOST$env:FOCUS_API_PREFIX"
          Write-Host "FOCUS: https://$FOCUS_URL  VERIFY_SSL=$env:VERIFY_SSL"
          
          # Get reachable status
          $REACHABLE = "${{ steps.preflight.outputs.reachable }}"
          if ([string]::IsNullOrEmpty($REACHABLE)) {
            $REACHABLE = "false"
          }
          Write-Host "Server reachable: $REACHABLE"
          Write-Host "Require server: $env:REQUIRE_SERVER"
          
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          # Fail if server is unreachable and REQUIRE_SERVER=true
          if ($REACHABLE -ne "true" -and $env:REQUIRE_SERVER -eq "true") {
            Write-Host "::error::Server unreachable and REQUIRE_SERVER=true - cannot run regression tests"
            $xmlContent = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="regression" tests="0" failures="0" errors="1" skipped="0" time="0"><testcase name="server_unreachable" classname="preflight"><error message="Server unreachable and REQUIRE_SERVER=true" type="ConnectionError">Server unreachable and REQUIRE_SERVER=true</error></testcase></testsuite>'
            $xmlContent | Out-File -FilePath reports/junit-regression.xml -Encoding utf8
            exit 1
          }
          
          # Skip tests if server unreachable and REQUIRE_SERVER=false
          if ($REACHABLE -ne "true") {
            Write-Host "✗ Server unreachable - skipping regression tests"
            $xmlContent = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="regression" tests="0" failures="0" errors="0" skipped="1" time="0"><testcase name="server_unreachable" classname="preflight"><skipped message="Server unreachable"/></testcase></testsuite>'
            $xmlContent | Out-File -FilePath reports/junit-regression.xml -Encoding utf8
            exit 0
          }
          
          # Run regression tests (excluding slow and nightly tests)
          pytest be_focus_server_tests/ `
            -m "regression and not slow and not nightly" `
            -v `
            --junitxml=reports/junit-regression.xml `
            --html=reports/regression-report.html `
            --self-contained-html `
            --json-report `
            --json-report-file=reports/regression-report.json

      - name: Generate console summary
        if: always()
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "========================================"
          Write-Host "REGRESSION TEST EXECUTION SUMMARY"
          Write-Host "========================================"
          if (Test-Path "reports/junit-regression.xml") {
            $scriptFile = "parse_xml.py"
            @"
import xml.etree.ElementTree as ET
import sys
try:
    tree = ET.parse('reports/junit-regression.xml')
    root = tree.getroot()
    if root.tag == 'testsuites':
        suites = root.findall('.//testsuite')
        total = sum(int(s.get('tests', 0)) for s in suites)
        failures = sum(int(s.get('failures', 0)) for s in suites)
        errors = sum(int(s.get('errors', 0)) for s in suites)
        skipped = sum(int(s.get('skipped', 0)) for s in suites)
        time = sum(float(s.get('time', 0)) for s in suites)
    elif root.tag == 'testsuite':
        total = int(root.get('tests', 0))
        failures = int(root.get('failures', 0))
        errors = int(root.get('errors', 0))
        skipped = int(root.get('skipped', 0))
        time = float(root.get('time', 0))
    else:
        testcases = root.findall('.//testcase')
        total = len(testcases)
        failures = len(root.findall('.//failure'))
        errors = len(root.findall('.//error'))
        skipped = len(root.findall('.//skipped'))
        time = 0.0
    passed = total - failures - errors - skipped
    print(f'Total Tests: {total}')
    print(f'Passed: {passed}')
    print(f'Failed: {failures}')
    print(f'Errors: {errors}')
    print(f'Skipped: {skipped}')
    print(f'Duration: {time:.2f}s')
except Exception as e:
    print(f'Error parsing XML: {e}')
    sys.exit(0)
"@ | Out-File -FilePath $scriptFile -Encoding utf8
            python $scriptFile
            Remove-Item $scriptFile -ErrorAction SilentlyContinue
            Write-Host "========================================"
            Write-Host ""
          } else {
            Write-Host "No test results found"
            Write-Host "========================================"
            Write-Host ""
          }

      - name: Upload test reports
        if: always()
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: regression-test-reports
          path: |
            reports/junit-*.xml
            reports/*.html
            reports/*.json
          retention-days: 7
          if-no-files-found: warn

      - name: Generate GitHub Actions summary
        if: always()
        shell: powershell
        env:
          ARTIFACT_DOWNLOAD_URL: ${{ steps.upload-artifact.outputs.url }}
        run: |
          $summaryPath = $env:GITHUB_STEP_SUMMARY
          if ([string]::IsNullOrEmpty($summaryPath)) {
            Write-Host "GITHUB_STEP_SUMMARY not set, skipping summary generation"
            exit 0
          }
          
          $scriptFile = "generate_summary.py"
          @"
import xml.etree.ElementTree as ET
import os
import sys

summaryPath = os.environ.get('GITHUB_STEP_SUMMARY', '')
artifactUrl = os.environ.get('ARTIFACT_DOWNLOAD_URL', '')

if not summaryPath:
    print('GITHUB_STEP_SUMMARY not set')
    sys.exit(0)

if os.path.exists('reports/junit-regression.xml'):
    try:
        tree = ET.parse('reports/junit-regression.xml')
        root = tree.getroot()
        
        if root.tag == 'testsuites':
            suites = root.findall('.//testsuite')
            total = sum(int(s.get('tests', 0)) for s in suites)
            failures = sum(int(s.get('failures', 0)) for s in suites)
            errors = sum(int(s.get('errors', 0)) for s in suites)
            skipped = sum(int(s.get('skipped', 0)) for s in suites)
            time = sum(float(s.get('time', 0)) for s in suites)
        elif root.tag == 'testsuite':
            total = int(root.get('tests', 0))
            failures = int(root.get('failures', 0))
            errors = int(root.get('errors', 0))
            skipped = int(root.get('skipped', 0))
            time = float(root.get('time', 0))
        else:
            testcases = root.findall('.//testcase')
            total = len(testcases)
            failures = len(root.findall('.//failure'))
            errors = len(root.findall('.//error'))
            skipped = len(root.findall('.//skipped'))
            time = 0.0
        
        passed = total - failures - errors - skipped
        timeRounded = round(time, 2)
        status = '[OK]' if failures == 0 and errors == 0 else '[FAIL]'
        
        with open(summaryPath, 'w', encoding='utf-8') as f:
            f.write(f'## Regression Tests Results {status}\n\n')
            f.write('| Metric | Value |\n')
            f.write('|--------|-------|\n')
            f.write(f'| **Total Tests** | {total} |\n')
            f.write(f'| **Passed** | {passed} |\n')
            f.write(f'| **Failed** | {failures} |\n')
            f.write(f'| **Errors** | {errors} |\n')
            f.write(f'| **Skipped** | {skipped} |\n')
            f.write(f'| **Duration** | {timeRounded}s |\n\n')
            f.write('### Test Reports\n\n')
            
            if artifactUrl:
                f.write(f'- [Download All Reports]({artifactUrl}) - Download ZIP with HTML, JSON, and JUnit XML reports\n\n')
            else:
                repo = os.environ.get('GITHUB_REPOSITORY', '')
                runId = os.environ.get('GITHUB_RUN_ID', '')
                serverUrl = os.environ.get('GITHUB_SERVER_URL', '')
                if repo and runId and serverUrl:
                    runUrl = f'{serverUrl}/{repo}/actions/runs/{runId}'
                    f.write(f'- [Download Reports]({runUrl}) - Go to workflow run page and download `regression-test-reports` artifact\n\n')
                else:
                    f.write('- Download Reports - Check artifacts section in workflow run\n\n')
            
            if failures > 0 or errors > 0:
                f.write('### Failed Tests\n\n')
                failedTests = root.findall('.//testcase[failure or error]')
                count = 0
                for test in failedTests[:10]:
                    name = test.get('name', 'unknown')
                    classname = test.get('classname', 'unknown')
                    failure = test.find('failure')
                    error = test.find('error')
                    msg = ''
                    if failure is not None:
                        msg = failure.get('message', '') or (failure.text or '')[:200]
                    elif error is not None:
                        msg = error.get('message', '') or (error.text or '')[:200]
                    msg = msg.replace('`', "'")[:200]
                    f.write(f'- **{classname}::{name}**\n')
                    f.write(f'  ```{msg}```\n\n')
                    count += 1
                if len(failedTests) > 10:
                    f.write(f'*... and {len(failedTests) - 10} more failures*\n\n')
        
        print('[OK] GitHub Actions summary generated')
    except Exception as e:
        with open(summaryPath, 'w', encoding='utf-8') as f:
            f.write(f'## Error parsing test results\n\nError: {e}\n')
        print(f'Error: {e}')
else:
    with open(summaryPath, 'w', encoding='utf-8') as f:
        f.write('## Warning: No test results found\n\n')
        f.write('Test execution may have failed before generating reports.\n')
"@ | Out-File -FilePath $scriptFile -Encoding utf8
          python $scriptFile
          Remove-Item $scriptFile -ErrorAction SilentlyContinue

