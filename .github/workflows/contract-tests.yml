name: Contract Tests

on:
  push:
    branches: [ main, develop, "**/feature/**", "**/chore/**" ]
  pull_request:
  workflow_dispatch:
    inputs:
      require_server:
        description: "Fail if Focus server is unreachable"
        default: "true"
        type: choice
        options: [ "true", "false" ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  contract:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.150' }}
      FOCUS_SERVER_PORT: ${{ secrets.FOCUS_SERVER_PORT || '30443' }}
      FOCUS_API_PREFIX: ${{ secrets.FOCUS_API_PREFIX || '/focus-server' }}
      VERIFY_SSL: ${{ secrets.VERIFY_SSL || 'false' }}
      REQUIRE_SERVER: ${{ inputs.require_server || secrets.REQUIRE_SERVER || 'false' }}
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install -U pip setuptools wheel
          
          echo "Installing dependencies (skipping requirements.txt due to resolution-too-deep)..."
          
          # Install core testing framework (pytest 9.0.1 first)
          pip install --no-cache-dir --prefer-binary \
            pytest==9.0.1 pytest-asyncio pytest-timeout pytest-mock pytest-html pytest-cov pytest-json-report pytest-xdist
          
          # Install HTTP and data processing
          pip install --no-cache-dir --prefer-binary \
            requests httpx beautifulsoup4 pydantic pydantic-settings orjson pyyaml
          
          # Install infrastructure packages
          pip install --no-cache-dir --prefer-binary \
            kubernetes pymongo paramiko pika structlog colorlog python-dateutil pytz psutil python-dotenv netaddr
          
          # Install optional packages (skip pytest-xray as it conflicts with pytest 9.0.1)
          pip install --no-cache-dir --prefer-binary \
            allure-pytest jinja2 asyncio-mqtt aiofiles || true
          
          echo "Dependency installation completed!"
          echo "Installed packages:"
          pip list | head -40

      - name: Preflight – check Focus availability
        id: preflight
        shell: bash
        continue-on-error: true
        run: |
          BASE="https://${FOCUS_SERVER_HOST}:${FOCUS_SERVER_PORT}${FOCUS_API_PREFIX}"
          echo "Checking $BASE/channels"
          set +e
          code=$(curl -sk -o /dev/null -w "%{http_code}" --max-time 10 "$BASE/channels" 2>/dev/null || echo "000")
          echo "status=$code" >> $GITHUB_OUTPUT
          if [[ "$code" -ge 200 && "$code" -lt 400 ]]; then
            echo "reachable=true" >> $GITHUB_OUTPUT
            echo "✅ Focus server is reachable"
          else
            echo "reachable=false" >> $GITHUB_OUTPUT
            echo "⚠️ Focus server unreachable (HTTP $code)"
            if [[ "${REQUIRE_SERVER}" == "true" ]]; then
              echo "::error::Focus server unreachable (HTTP $code)"
              exit 1
            fi
          fi

      - name: Debug curl (unreachable)
        if: ${{ steps.preflight.outputs.reachable != 'true' }}
        shell: bash
        continue-on-error: true
        run: |
          BASE="https://${FOCUS_SERVER_HOST}:${FOCUS_SERVER_PORT}${FOCUS_API_PREFIX}"
          echo "Diagnostic curl -vk $BASE/channels"
          curl -vk --max-time 10 "$BASE/channels" || true

      - name: Run contract tests
        shell: bash
        continue-on-error: true
        run: |
          echo "FOCUS: $FOCUS_SERVER_HOST:$FOCUS_SERVER_PORT$FOCUS_API_PREFIX  VERIFY_SSL=$VERIFY_SSL"
          echo "Server reachable: ${{ steps.preflight.outputs.reachable }}"
          echo "Require server: ${{ env.REQUIRE_SERVER }}"
          mkdir -p reports
          
          # Run tests even if server is unreachable (unless REQUIRE_SERVER=true)
          if [[ "${{ steps.preflight.outputs.reachable }}" != "true" && "${{ env.REQUIRE_SERVER }}" == "true" ]]; then
            echo "ERROR: Server unreachable and REQUIRE_SERVER=true - skipping tests"
            # Create empty report
            echo '<?xml version="1.0" encoding="UTF-8"?><testsuite name="contract" tests="0" failures="0" errors="1" skipped="0" time="0"><error message="Server unreachable and REQUIRE_SERVER=true"/></testsuite>' > reports/junit-contract.xml
            exit 1
          fi
          
          pytest -v focus_server_api_load_tests/focus_api_tests/test_api_contract.py \
            --junitxml=reports/junit-contract.xml \
            --html=reports/contract-report.html \
            --self-contained-html \
            --json-report \
            --json-report-file=reports/contract-report.json \
            --maxfail=10 || echo "Tests completed with errors"

      - name: Generate console summary
        if: always()
        shell: bash
        run: |
          echo ""
          echo "========================================"
          echo "TEST EXECUTION SUMMARY"
          echo "========================================"
          if [ -f "reports/junit-contract.xml" ]; then
            python3 << 'EOF'
import xml.etree.ElementTree as ET
import sys
try:
    tree = ET.parse("reports/junit-contract.xml")
    root = tree.getroot()
    
    # Handle both testsuites and testsuite
    if root.tag == "testsuites":
        suites = root.findall(".//testsuite")
        total = sum(int(s.get("tests", 0)) for s in suites)
        failures = sum(int(s.get("failures", 0)) for s in suites)
        errors = sum(int(s.get("errors", 0)) for s in suites)
        skipped = sum(int(s.get("skipped", 0)) for s in suites)
        time = sum(float(s.get("time", 0)) for s in suites)
    else:
        total = int(root.get("tests", 0))
        failures = int(root.get("failures", 0))
        errors = int(root.get("errors", 0))
        skipped = int(root.get("skipped", 0))
        time = float(root.get("time", 0))
    
    passed = total - failures - errors - skipped
    print(f"Total Tests: {total}")
    print(f"Passed: {passed}")
    print(f"Failed: {failures}")
    print(f"Errors: {errors}")
    print(f"Duration: {time:.2f}s")
except Exception as e:
    print(f"Error parsing XML: {e}")
    sys.exit(0)
EOF
            echo "========================================"
            echo ""
          else
            echo "No test results found"
            echo "========================================"
            echo ""
          fi

      - name: Upload test reports
        if: always()
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: contract-test-reports
          path: |
            reports/junit-*.xml
            reports/*.html
            reports/*.json
          retention-days: 30
          if-no-files-found: warn

      - name: Get artifact download URL
        if: always() && steps.upload-artifact.outcome == 'success'
        id: get-artifact-url
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'EOF'
import os
import time
import json
import urllib.request
import urllib.error

repo = os.environ.get("GITHUB_REPOSITORY", "")
runId = os.environ.get("GITHUB_RUN_ID", "")
token = os.environ.get("GITHUB_TOKEN", "")
artifactName = "contract-test-reports"
outputFile = os.environ.get("GITHUB_OUTPUT", "")

if not repo or not runId or not token:
    print("Missing required environment variables")
    exit(0)

artifactsUrl = f"https://api.github.com/repos/{repo}/actions/runs/{runId}/artifacts"
headers = {
    "Authorization": f"Bearer {token}",
    "Accept": "application/vnd.github.v3+json"
}

maxRetries = 5
retryDelay = 2
artifactId = None

for i in range(1, maxRetries + 1):
    try:
        print(f"Attempt {i} of {maxRetries} to get artifact ID...")
        req = urllib.request.Request(artifactsUrl, headers=headers)
        with urllib.request.urlopen(req, timeout=10) as response:
            data = json.loads(response.read())
            
            artifacts = data.get("artifacts", [])
            print(f"Found {len(artifacts)} artifacts")
            for artifact in artifacts:
                print(f"  - {artifact.get('name')} (ID: {artifact.get('id')})")
            
            artifact = next((a for a in artifacts if a.get("name") == artifactName), None)
            
            if artifact:
                artifactId = artifact.get("id")
                serverUrl = os.environ.get("GITHUB_SERVER_URL", "https://github.com")
                downloadUrl = f"{serverUrl}/{repo}/actions/runs/{runId}/artifacts/{artifactId}"
                
                if outputFile:
                    with open(outputFile, "a", encoding="utf-8") as f:
                        f.write(f"url={downloadUrl}\n")
                
                print(f"Found artifact ID: {artifactId}")
                print(f"Download URL: {downloadUrl}")
                break
            else:
                print(f"Artifact '{artifactName}' not found in response")
                if i < maxRetries:
                    print(f"Waiting {retryDelay} seconds before retry...")
                    time.sleep(retryDelay)
    except urllib.error.HTTPError as e:
        print(f"HTTP Error on attempt {i}: {e.code} - {e.reason}")
        if i < maxRetries:
            time.sleep(retryDelay)
    except Exception as e:
        print(f"Error on attempt {i}: {e}")
        if i < maxRetries:
            time.sleep(retryDelay)

if not artifactId:
    print(f"ERROR: Could not get artifact ID after {maxRetries} attempts")
EOF

      - name: Generate GitHub Actions summary
        if: always()
        shell: bash
        env:
          ARTIFACT_DOWNLOAD_URL: ${{ steps.get-artifact-url.outputs.url }}
        run: |
          summaryPath="$GITHUB_STEP_SUMMARY"
          if [ -z "$summaryPath" ]; then
            echo "GITHUB_STEP_SUMMARY not set, skipping summary generation"
            exit 0
          fi
          
          python3 << EOF
import xml.etree.ElementTree as ET
import os
import sys

summaryPath = os.environ.get("GITHUB_STEP_SUMMARY", "")
artifactUrl = os.environ.get("ARTIFACT_DOWNLOAD_URL", "")

if not summaryPath:
    print("GITHUB_STEP_SUMMARY not set")
    sys.exit(0)

if os.path.exists("reports/junit-contract.xml"):
    try:
        tree = ET.parse("reports/junit-contract.xml")
        root = tree.getroot()
        
        # Handle both testsuites and testsuite
        if root.tag == "testsuites":
            suites = root.findall(".//testsuite")
            total = sum(int(s.get("tests", 0)) for s in suites)
            failures = sum(int(s.get("failures", 0)) for s in suites)
            errors = sum(int(s.get("errors", 0)) for s in suites)
            skipped = sum(int(s.get("skipped", 0)) for s in suites)
            time = sum(float(s.get("time", 0)) for s in suites)
        else:
            total = int(root.get("tests", 0))
            failures = int(root.get("failures", 0))
            errors = int(root.get("errors", 0))
            skipped = int(root.get("skipped", 0))
            time = float(root.get("time", 0))
        
        passed = total - failures - errors - skipped
        timeRounded = round(time, 2)
        status = "[OK]" if failures == 0 and errors == 0 else "[FAIL]"
        
        with open(summaryPath, "w", encoding="utf-8") as f:
            f.write(f"## Contract Tests Results {status}\n\n")
            f.write("| Metric | Value |\n")
            f.write("|--------|-------|\n")
            f.write(f"| **Total Tests** | {total} |\n")
            f.write(f"| **Passed** | {passed} |\n")
            f.write(f"| **Failed** | {failures} |\n")
            f.write(f"| **Errors** | {errors} |\n")
            f.write(f"| **Skipped** | {skipped} |\n")
            f.write(f"| **Duration** | {timeRounded}s |\n\n")
            f.write("### Test Reports\n\n")
            
            if artifactUrl:
                f.write(f"- [Download All Reports]({artifactUrl}) - Download ZIP with HTML, JSON, and JUnit XML reports\n\n")
            else:
                repo = os.environ.get("GITHUB_REPOSITORY", "")
                runId = os.environ.get("GITHUB_RUN_ID", "")
                serverUrl = os.environ.get("GITHUB_SERVER_URL", "")
                if repo and runId and serverUrl:
                    runUrl = f"{serverUrl}/{repo}/actions/runs/{runId}"
                    f.write(f"- [Download Reports]({runUrl}) - Go to workflow run page and download \`contract-test-reports\` artifact\n\n")
                else:
                    f.write("- Download Reports - Check artifacts section in workflow run\n\n")
            
            if failures > 0 or errors > 0:
                f.write("### Failed Tests\n\n")
                failedTests = root.findall(".//testcase[failure or error]")
                count = 0
                for test in failedTests[:10]:
                    name = test.get("name", "unknown")
                    classname = test.get("classname", "unknown")
                    failure = test.find("failure")
                    error = test.find("error")
                    msg = ""
                    if failure is not None:
                        msg = failure.get("message", "") or (failure.text or "")[:200]
                    elif error is not None:
                        msg = error.get("message", "") or (error.text or "")[:200]
                    msg = msg.replace("`", "'")[:200]
                    f.write(f"- **{classname}::{name}**\n")
                    f.write(f"  ```{msg}```\n\n")
                    count += 1
                if len(failedTests) > 10:
                    f.write(f"*... and {len(failedTests) - 10} more failures*\n\n")
        
        print("[OK] GitHub Actions summary generated")
    except Exception as e:
        with open(summaryPath, "w", encoding="utf-8") as f:
            f.write(f"## Error parsing test results\n\nError: {e}\n")
        print(f"Error: {e}")
else:
    with open(summaryPath, "w", encoding="utf-8") as f:
        f.write("## Warning: No test results found\n\n")
        f.write("Test execution may have failed before generating reports.\n")
EOF

