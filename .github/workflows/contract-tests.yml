name: Contract Tests

on:
  push:
    branches: [ main, develop, "**/feature/**", "**/chore/**" ]
  pull_request:
  workflow_dispatch:
    inputs:
      require_server:
        description: "Fail if Focus server is unreachable"
        default: "true"
        type: choice
        options: [ "true", "false" ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  contract:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.150' }}
      FOCUS_SERVER_PORT: ${{ secrets.FOCUS_SERVER_PORT || '30443' }}
      FOCUS_API_PREFIX: ${{ secrets.FOCUS_API_PREFIX || '/focus-server' }}
      VERIFY_SSL: ${{ secrets.VERIFY_SSL || 'false' }}
      REQUIRE_SERVER: ${{ inputs.require_server || secrets.REQUIRE_SERVER || 'false' }}
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install -U pip setuptools wheel
          
          echo "Installing dependencies in priority order..."
          
          # Stage 1: Core testing framework
          echo "Stage 1: Core testing framework..."
          pip install --no-cache-dir --prefer-binary \
            "pytest>=7.4.0,<9.0.0" \
            "pytest-asyncio>=0.21.1,<0.24.0" \
            "pytest-timeout>=2.2.0,<3.0.0" \
            "pytest-mock>=3.12.0,<4.0.0" \
            "pytest-html>=4.1.1,<5.0.0" \
            "pytest-cov>=4.1.0,<5.0.0" \
            "pytest-json-report>=1.5.0,<2.0.0" \
            "pytest-xdist>=3.3.1,<4.0.0"
          
          # Stage 2: HTTP and data processing
          echo "Stage 2: HTTP and data processing..."
          pip install --no-cache-dir --prefer-binary \
            "requests>=2.31.0,<3.0.0" \
            "httpx>=0.24.1,<0.30.0" \
            "beautifulsoup4>=4.12.0,<5.0.0" \
            "pydantic>=2.4.0,<3.0.0" \
            "pydantic-settings>=2.0.0,<3.0.0" \
            "orjson>=3.9.10,<4.0.0" \
            "pyyaml>=6.0.1,<7.0.0"
          
          # Stage 3: Infrastructure packages
          echo "Stage 3: Infrastructure packages..."
          pip install --no-cache-dir --prefer-binary \
            "kubernetes>=28.1.0,<35.0.0" \
            "pymongo>=4.6.0,<5.0.0" \
            "paramiko>=3.3.1,<5.0.0" \
            "pika>=1.3.0,<2.0.0" \
            "structlog>=23.2.0,<26.0.0" \
            "colorlog>=6.7.0,<7.0.0" \
            "python-dateutil>=2.8.2,<3.0.0" \
            "pytz>=2023.3,<2026.0" \
            "psutil>=5.9.6,<8.0.0" \
            "python-dotenv>=1.0.1,<2.0.0" \
            "netaddr>=0.10.1,<2.0.0"
          
          # Stage 4: Reporting and optional packages
          echo "Stage 4: Reporting packages..."
          pip install --no-cache-dir --prefer-binary \
            "allure-pytest>=2.13.0,<3.0.0" \
            "jinja2>=3.1.2,<4.0.0" \
            "asyncio-mqtt>=0.16.1,<1.0.0" \
            "aiofiles>=23.2.0,<26.0.0" || true
          pip install --no-cache-dir --prefer-binary "pytest-xray>=0.2.1,<1.0.0" || true
          
          echo "Dependency installation completed!"
          echo "Installed packages:"
          pip list | head -40

      - name: Preflight â€“ check Focus availability
        id: preflight
        shell: bash
        run: |
          BASE="https://${FOCUS_SERVER_HOST}:${FOCUS_SERVER_PORT}${FOCUS_API_PREFIX}"
          echo "Checking $BASE/channels"
          set +e
          code=$(curl -sk -o /dev/null -w "%{http_code}" "$BASE/channels")
          echo "status=$code" >> $GITHUB_OUTPUT
          if [[ "$code" -ge 200 && "$code" -lt 400 ]]; then
            echo "reachable=true" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "reachable=false" >> $GITHUB_OUTPUT
            if [[ "${REQUIRE_SERVER}" == "true" ]]; then
              echo "::error::Focus server unreachable (HTTP $code)"
              exit 1
            fi
            exit 0
          fi

      - name: Debug curl (unreachable)
        if: ${{ steps.preflight.outputs.reachable != 'true' }}
        shell: bash
        run: |
          BASE="https://${FOCUS_SERVER_HOST}:${FOCUS_SERVER_PORT}${FOCUS_API_PREFIX}"
          echo "Diagnostic curl -vk $BASE/channels"
          curl -vk "$BASE/channels" || true

      - name: Run contract tests
        if: ${{ steps.preflight.outputs.reachable == 'true' }}
        run: |
          echo "FOCUS: $FOCUS_SERVER_HOST:$FOCUS_SERVER_PORT$FOCUS_API_PREFIX  VERIFY_SSL=$VERIFY_SSL"
          mkdir -p reports
          pytest -q focus_server_api_load_tests/focus_api_tests/test_api_contract.py \
            --junitxml=reports/junit.xml

      - name: Upload test report (junit)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: reports/junit.xml

