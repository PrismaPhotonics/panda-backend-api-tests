name: Load and Performance Tests

on:
  schedule:
    # Run every night at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      require_server:
        description: "Fail if Focus server is unreachable"
        default: "true"
        type: choice
        options: [ "true", "false" ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  load-performance:
    # IMPORTANT: Use self-hosted Windows runner for production environment access
    # Cloud runners cannot access internal network (10.10.10.100)
    runs-on: [self-hosted, Windows]
    timeout-minutes: 120

    env:
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.100' }}
      FOCUS_SERVER_PORT: ${{ secrets.FOCUS_SERVER_PORT || '' }}
      FOCUS_API_PREFIX: ${{ secrets.FOCUS_API_PREFIX || '/focus-server' }}
      VERIFY_SSL: ${{ secrets.VERIFY_SSL || 'false' }}
      REQUIRE_SERVER: ${{ inputs.require_server || secrets.REQUIRE_SERVER || 'true' }}
      ENVIRONMENT: ${{ secrets.ENVIRONMENT || 'new_production' }}
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'

          python -m pip install -U pip setuptools wheel

          function Install-PipWithRetry {
            param(
              [string]$groupName,
              [string]$packages,
              [bool]$fatal = $true
            )

            $maxAttempts = 3

            for ($attempt = 1; $attempt -le $maxAttempts; $attempt++) {
              Write-Host "Attempt $($attempt)/$($maxAttempts): Installing $($groupName)"
              try {
                # Run pip and capture verbose output to a per-group log
                pip install --no-cache-dir --prefer-binary $packages -v 2>&1 | Tee-Object -FilePath "pip-install-$($groupName).log"
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "✓ $($groupName) installed successfully (attempt $($attempt))"
                  return 0
                }
              } catch {
                Write-Host "pip exited with error on attempt $($attempt) for $($groupName): $($_.Exception.Message)"
              }

              Write-Host "✗ Attempt $($attempt) failed for $($groupName)"
              if ($attempt -lt $maxAttempts) { Start-Sleep -Seconds (5 * $attempt) }
            }

            Write-Host "All attempts failed for $($groupName)"
            pip --version
            python -V
            if ($fatal) {
              Write-Host "::error::Failed installing $($groupName) after $($maxAttempts) attempts. See pip-install-$($groupName).log"
              exit 1
            } else {
              Write-Host "Optional group $($groupName) failed to install; continuing without these optional packages. See pip-install-$($groupName).log"
            }
          }

          Write-Host "Installing core test packages..."
          Install-PipWithRetry -groupName 'core-test-packages' -packages 'pytest==9.0.1 pytest-asyncio pytest-timeout pytest-mock pytest-html pytest-cov pytest-json-report pytest-xdist' -fatal $true

          Write-Host "Installing HTTP and data packages..."
          Install-PipWithRetry -groupName 'http-data-packages' -packages 'requests httpx beautifulsoup4 pydantic pydantic-settings orjson pyyaml' -fatal $true

          Write-Host "Installing infra packages..."
          Install-PipWithRetry -groupName 'infra-packages' -packages 'kubernetes pymongo paramiko pika structlog colorlog python-dateutil pytz psutil python-dotenv netaddr' -fatal $true

          Write-Host "Installing pinned isort..."
          Install-PipWithRetry -groupName 'isort' -packages 'isort==5.13.2' -fatal $true

          Write-Host "Installing optional packages (non-fatal)..."
          Install-PipWithRetry -groupName 'optional-packages' -packages 'allure-pytest jinja2 asyncio-mqtt aiofiles' -fatal $false

          Write-Host "Dependency installation completed!"

          # Attempt to list installed packages to a file (non-fatal)
          try {
            $ErrorActionPreference = 'Continue'
            pip list --format=freeze 2>&1 | Select-Object -First 40 | ForEach-Object { Write-Host $_ }
          } catch {
            Write-Host "Could not list packages (non-critical)"
          }

      - name: Upload pip install logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-install-logs
          path: |
            pip-install-*.log
          retention-days: 5
          if-no-files-found: ignore

      - name: Preflight – check Focus availability
        id: preflight
        shell: powershell
        continue-on-error: true
        run: |
          # Ensure reports directory exists so preflight can write JUnit XML
          New-Item -ItemType Directory -Force -Path reports | Out-Null

          # Initialize outputs with defaults
          echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          echo "status=000" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          # Build base URL
          $BASE = "https://$env:FOCUS_SERVER_HOST$env:FOCUS_API_PREFIX"
          Write-Host "Checking $BASE/channels"
          Write-Host "FOCUS_SERVER_HOST: $env:FOCUS_SERVER_HOST"
          Write-Host "FOCUS_SERVER_PORT: $($env:FOCUS_SERVER_PORT -replace '^$', '(not used - HTTPS default)')"
          Write-Host "REQUIRE_SERVER: $env:REQUIRE_SERVER"
          Write-Host ""
          Write-Host "Network diagnostics:"
          Write-Host "  Hostname: $env:COMPUTERNAME"
          Write-Host "  User: $env:USERNAME"
          Write-Host ""
          Write-Host "Testing HTTP connection:"
          Write-Host "  URL: $BASE/channels"
          
          try {
            # Configure certificate handling for different PowerShell versions
            $skipCert = $false
            if ($env:VERIFY_SSL -eq 'false') {
              if ($PSVersionTable.PSVersion.Major -ge 7) {
                $skipCert = $true
              } else {
                [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }
              }
            }

            $invokeParams = @{ Uri = "$BASE/channels"; Method = 'Get'; TimeoutSec = 30; ErrorAction = 'Stop' }
            if ($skipCert) { $invokeParams['SkipCertificateCheck'] = $true }

            $response = Invoke-WebRequest @invokeParams
            $code = $response.StatusCode
            
            if ($code -ge 200 -and $code -lt 400) {
              Write-Host "  ✓ HTTP request succeeded with HTTP $code"
              Write-Host "  Response: $($response.Content.Substring(0, [Math]::Min(100, $response.Content.Length)))"
              echo "reachable=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              Write-Host "✓ Focus server is reachable"
            } else {
              echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              Write-Host "✗ Focus server unreachable (HTTP $code)"
            }
          } catch {
            $code = "000"
            echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            Write-Host "✗ Focus server unreachable (Connection failed)"
            Write-Host "  Error: $($_.Exception.Message)"
            
            if ($env:REQUIRE_SERVER -eq "true") {
              Write-Host "::error::Focus server unreachable. Server must be accessible for load and performance tests."
            }
          }
          
          Write-Host ""
          Write-Host "Final HTTP status code: $code"

      - name: Run load and performance tests
        shell: powershell
        run: |
          $FOCUS_URL = "$env:FOCUS_SERVER_HOST$env:FOCUS_API_PREFIX"
          Write-Host "FOCUS: https://$FOCUS_URL  VERIFY_SSL=$env:VERIFY_SSL"
          
          # Get reachable status
          $REACHABLE = "${{ steps.preflight.outputs.reachable }}"
          if ([string]::IsNullOrEmpty($REACHABLE)) {
            $REACHABLE = "false"
          }
          Write-Host "Server reachable: $REACHABLE"
          Write-Host "Require server: $env:REQUIRE_SERVER"
          
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          # Fail if server is unreachable and REQUIRE_SERVER=true
          if ($REACHABLE -ne "true" -and $env:REQUIRE_SERVER -eq "true") {
            Write-Host "::error::Server unreachable and REQUIRE_SERVER=true - cannot run load and performance tests"
            $xmlContent = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="load-performance" tests="0" failures="0" errors="1" skipped="0" time="0"><testcase name="server_unreachable" classname="preflight"><error message="Server unreachable and REQUIRE_SERVER=true" type="ConnectionError">Server unreachable and REQUIRE_SERVER=true</error></testcase></testsuite>'
            $xmlContent | Out-File -FilePath reports/junit-load-performance.xml -Encoding utf8
            exit 1
          }
          
          # Skip tests if server unreachable and REQUIRE_SERVER=false
          if ($REACHABLE -ne "true") {
            Write-Host "✗ Server unreachable - skipping load and performance tests"
            $xmlContent = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="load-performance" tests="0" failures="0" errors="0" skipped="1" time="0"><testcase name="server_unreachable" classname="preflight"><skipped message="Server unreachable"/></testcase></testsuite>'
            $xmlContent | Out-File -FilePath reports/junit-load-performance.xml -Encoding utf8
            exit 0
          }
          
          # Run load and performance tests
          pytest be_focus_server_tests/ `
            -m "load or performance" `
            --monitor-pods `
            -v `
            --junitxml=reports/junit-load-performance.xml `
            --html=reports/load-performance-report.html `
            --self-contained-html `
            --json-report `
            --json-report-file=reports/load-performance-report.json

      - name: Generate console summary
        if: always()
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "========================================"
          Write-Host "LOAD AND PERFORMANCE TEST EXECUTION SUMMARY"
          Write-Host "========================================"
          if (Test-Path "reports/junit-load-performance.xml") {
            python scripts/parse_junit_xml.py reports/junit-load-performance.xml
            Write-Host "========================================"
            Write-Host ""
          } else {
            Write-Host "No test results found"
            Write-Host "========================================"
            Write-Host ""
          }

      - name: Upload test reports
        if: always()
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: load-performance-test-reports
          path: |
            reports/junit-*.xml
            reports/*.html
            reports/*.json
          retention-days: 7
          if-no-files-found: warn

      - name: Generate GitHub Actions summary
        if: always()
        shell: powershell
        env:
          ARTIFACT_DOWNLOAD_URL: ${{ steps.upload-artifact.outputs.url }}
        run: |
          $summaryPath = $env:GITHUB_STEP_SUMMARY
          if ([string]::IsNullOrEmpty($summaryPath)) {
            Write-Host "GITHUB_STEP_SUMMARY not set, skipping summary generation"
            exit 0
          }
          
          python scripts/generate_github_summary.py reports/junit-load-performance.xml

