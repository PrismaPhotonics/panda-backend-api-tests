name: Load and Performance Tests

on:
  schedule:
    # Run every night at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      require_server:
        description: "Fail if Focus server is unreachable"
        default: "true"
        type: choice
        options: [ "true", "false" ]

env:
  PYTHON_VERSION: '3.13'

jobs:
  load-performance:
    # IMPORTANT: Use self-hosted Windows runner for production environment access
    # Cloud runners cannot access internal network (10.10.10.100)
    runs-on: [self-hosted, windows, "panda_automation"]
    timeout-minutes: 120

    env:
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.100' }}
      FOCUS_SERVER_PORT: ${{ secrets.FOCUS_SERVER_PORT || '' }}
      FOCUS_API_PREFIX: ${{ secrets.FOCUS_API_PREFIX || '/focus-server' }}
      VERIFY_SSL: ${{ secrets.VERIFY_SSL || 'false' }}
      REQUIRE_SERVER: ${{ inputs.require_server || secrets.REQUIRE_SERVER || 'true' }}
      ENVIRONMENT: ${{ secrets.ENVIRONMENT || 'new_production' }}
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        shell: powershell
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\install_dependencies.ps1

      - name: Install project in editable mode
        shell: powershell
        run: |
          Write-Host "Installing project in editable mode..."
          python -m pip install -e .
          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Failed to install project in editable mode"
            exit 1
          }
          Write-Host "Project installed successfully"

      - name: Upload pip install logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-install-logs
          path: |
            pip-install-*.log
          retention-days: 5
          if-no-files-found: ignore

      - name: Preflight – check Focus availability
        id: preflight
        shell: powershell
        continue-on-error: true
        run: |
          # Ensure reports directory exists so preflight can write JUnit XML
          New-Item -ItemType Directory -Force -Path reports | Out-Null

          # Initialize outputs with defaults
          echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          echo "status=000" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          # Build base URL
          $BASE = "https://$env:FOCUS_SERVER_HOST$env:FOCUS_API_PREFIX"
          Write-Host "Checking $BASE/channels"
          Write-Host "FOCUS_SERVER_HOST: $env:FOCUS_SERVER_HOST"
          Write-Host "FOCUS_SERVER_PORT: $($env:FOCUS_SERVER_PORT -replace '^$', '(not used - HTTPS default)')"
          Write-Host "REQUIRE_SERVER: $env:REQUIRE_SERVER"
          Write-Host ""
          Write-Host "Network diagnostics:"
          Write-Host "  Hostname: $env:COMPUTERNAME"
          Write-Host "  User: $env:USERNAME"
          Write-Host ""
          Write-Host "Testing HTTP connection with curl.exe:"
          Write-Host "  URL: $BASE/channels"
          
          try {
            # Use curl.exe which works reliably with TLS on PowerShell 5.1
            $curlOutput = curl.exe -k -s -w "`n%{http_code}" "$BASE/channels" 2>&1
            if ($LASTEXITCODE -eq 0) {
              # Split output: last line is status code, rest is response
              $lines = $curlOutput -split "`n"
              $code = $lines[-1].Trim()
              $responseBody = ($lines[0..($lines.Length-2)] -join "`n").Trim()
              
              if ($code -match '^\d{3}$' -and [int]$code -ge 200 -and [int]$code -lt 400) {
                Write-Host "  [OK] HTTP request succeeded with HTTP $code"
                Write-Host "  Response: $($responseBody.Substring(0, [Math]::Min(100, $responseBody.Length)))"
                echo "reachable=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
                echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
                Write-Host "[OK] Focus server is reachable"
              } else {
                echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
                echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
                Write-Host "[FAIL] Focus server unreachable (HTTP $code)"
              }
            } else {
              throw "curl.exe failed with exit code: $LASTEXITCODE"
            }
          } catch {
            $code = "000"
            echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            Write-Host "[FAIL] Focus server unreachable (Connection failed)"
            Write-Host "  Error: $($_.Exception.Message)"
            
            if ($env:REQUIRE_SERVER -eq "true") {
              Write-Host "::error::Focus server unreachable. Server must be accessible for load and performance tests."
            }
          }
          
          Write-Host ""
          Write-Host "Final HTTP status code: $code"

      - name: Run load and performance tests
        shell: powershell
        run: |
          $FOCUS_URL = "$env:FOCUS_SERVER_HOST$env:FOCUS_API_PREFIX"
          Write-Host "FOCUS: https://$FOCUS_URL  VERIFY_SSL=$env:VERIFY_SSL"
          
          # Get reachable status
          $REACHABLE = "${{ steps.preflight.outputs.reachable }}"
          if ([string]::IsNullOrEmpty($REACHABLE)) {
            $REACHABLE = "false"
          }
          Write-Host "Server reachable: $REACHABLE"
          Write-Host "Require server: $env:REQUIRE_SERVER"
          
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          # Fail if server is unreachable and REQUIRE_SERVER=true
          if ($REACHABLE -ne "true" -and $env:REQUIRE_SERVER -eq "true") {
            Write-Host "::error::Server unreachable and REQUIRE_SERVER=true - cannot run load and performance tests"
            $xmlContent = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="load-performance" tests="0" failures="0" errors="1" skipped="0" time="0"><testcase name="server_unreachable" classname="preflight"><error message="Server unreachable and REQUIRE_SERVER=true" type="ConnectionError">Server unreachable and REQUIRE_SERVER=true</error></testcase></testsuite>'
            $xmlContent | Out-File -FilePath reports/junit-load-performance.xml -Encoding utf8
            exit 1
          }
          
          # Skip tests if server unreachable and REQUIRE_SERVER=false
          if ($REACHABLE -ne "true") {
            Write-Host "✗ Server unreachable - skipping load and performance tests"
            $xmlContent = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="load-performance" tests="0" failures="0" errors="0" skipped="1" time="0"><testcase name="server_unreachable" classname="preflight"><skipped message="Server unreachable"/></testcase></testsuite>'
            $xmlContent | Out-File -FilePath reports/junit-load-performance.xml -Encoding utf8
            exit 0
          }
          
          # Run load and performance tests (excluding UI tests that require playwright)
          # Runs all tests with @pytest.mark.load or @pytest.mark.performance markers
          # Skip health check for load/performance tests - they only need Focus Server API (already checked in preflight)
          Write-Host "Running tests with Python..."
          python -m pytest be_focus_server_tests/ `
            -m "load or performance" `
            --ignore=be_focus_server_tests/ui `
            --skip-health-check `
            --monitor-pods `
            -v `
            --junitxml=reports/junit-load-performance.xml `
            --html=reports/load-performance-report.html `
            --self-contained-html `
            --json-report `
            --json-report-file=reports/load-performance-report.json

      - name: Generate console summary
        if: always()
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "========================================"
          Write-Host "LOAD AND PERFORMANCE TEST EXECUTION SUMMARY"
          Write-Host "========================================"
          if (Test-Path "reports/junit-load-performance.xml") {
            python scripts/parse_junit_xml.py reports/junit-load-performance.xml
            Write-Host "========================================"
            Write-Host ""
          } else {
            Write-Host "No test results found"
            Write-Host "========================================"
            Write-Host ""
          }

      - name: Upload test reports
        if: always()
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: load-performance-test-reports
          path: |
            reports/junit-*.xml
            reports/*.html
            reports/*.json
          retention-days: 7
          if-no-files-found: warn

      - name: Generate GitHub Actions summary
        if: always()
        shell: powershell
        env:
          ARTIFACT_DOWNLOAD_URL: ${{ steps.upload-artifact.outputs.url }}
        run: |
          $summaryPath = $env:GITHUB_STEP_SUMMARY
          if ([string]::IsNullOrEmpty($summaryPath)) {
            Write-Host "GITHUB_STEP_SUMMARY not set, skipping summary generation"
            exit 0
          }
          
          python scripts/generate_github_summary.py reports/junit-load-performance.xml

