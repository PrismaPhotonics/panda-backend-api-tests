name: Load and Performance Tests

on:
  schedule:
    # Run every night at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      require_server:
        description: "Fail if Focus server is unreachable"
        default: "true"
        type: choice
        options: [ "true", "false" ]

env:
  PYTHON_VERSION: '3.13'

jobs:
  load-performance:
    # IMPORTANT: Use self-hosted Windows runner for production environment access
    # Cloud runners cannot access internal network (10.10.10.100)
    runs-on: [self-hosted, windows, "panda_automation"]
    timeout-minutes: 120

    env:
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.100' }}
      FOCUS_SERVER_PORT: ${{ secrets.FOCUS_SERVER_PORT || '' }}
      FOCUS_API_PREFIX: ${{ secrets.FOCUS_API_PREFIX || '/focus-server' }}
      VERIFY_SSL: ${{ secrets.VERIFY_SSL || 'false' }}
      REQUIRE_SERVER: ${{ inputs.require_server || secrets.REQUIRE_SERVER || 'true' }}
      ENVIRONMENT: ${{ secrets.ENVIRONMENT || 'staging' }}
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        shell: powershell
        run: |
          $ErrorActionPreference = 'Continue'
          # Use existing Python installation instead of setup-python to avoid registry permission issues
          # Try py launcher first
          $pythonCmd = $null
          $pythonVersion = py --version 2>&1
          if ($LASTEXITCODE -eq 0) {
            $pythonCmd = "py"
            Write-Host "Found Python via py launcher: $pythonVersion"
            # Get Python path and Scripts directory
            $pythonPath = py -c "import sys; print(sys.executable)" 2>&1
            if ($pythonPath -and -not ($pythonPath -match "Error|Exception")) {
              $pythonDir = Split-Path $pythonPath
              $scriptsDir = Join-Path $pythonDir "Scripts"
              
              # Use GITHUB_PATH to persist PATH across steps
              if ($env:GITHUB_PATH) {
                echo "$pythonDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                echo "$scriptsDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
              }
              
              Write-Host "Python path: $pythonPath"
              Write-Host "Scripts path: $scriptsDir"
            } else {
              Write-Host "Warning: Could not get Python path, but py launcher works"
            }
          } else {
            Write-Host "Python not found via py launcher, trying python directly..."
            # Try python command
            $pythonVersion = python --version 2>&1
            if ($LASTEXITCODE -eq 0) {
              $pythonCmd = "python"
              Write-Host "Found Python via python command: $pythonVersion"
              # Get Python path
              $pythonPath = python -c "import sys; print(sys.executable)" 2>&1
              if ($pythonPath -and -not ($pythonPath -match "Error|Exception")) {
                $pythonDir = Split-Path $pythonPath
                $scriptsDir = Join-Path $pythonDir "Scripts"
                
                if ($env:GITHUB_PATH) {
                  echo "$pythonDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                  echo "$scriptsDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                }
                
                Write-Host "Python path: $pythonPath"
                Write-Host "Scripts path: $scriptsDir"
              }
            } else {
              # Try to find python in common locations
              Write-Host "Python not found in PATH, searching common locations..."
              
              # Try Get-Command first (searches PATH)
              $foundPythonCmd = Get-Command python.exe -ErrorAction SilentlyContinue
              if ($foundPythonCmd) {
                $pythonPath = $foundPythonCmd.Source
                $pythonDir = Split-Path $pythonPath
                $scriptsDir = Join-Path $pythonDir "Scripts"
                
                if ($env:GITHUB_PATH) {
                  echo "$pythonDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                  echo "$scriptsDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                }
                
                Write-Host "Found Python via Get-Command at: $pythonPath"
                $pythonCmd = $pythonPath
              } else {
                # Search common installation paths
                $pythonPaths = @(
                  "C:\Python*",
                  "${env:ProgramFiles}\Python*",
                  "${env:ProgramFiles(x86)}\Python*",
                  "${env:LOCALAPPDATA}\Programs\Python\Python*",
                  "C:\ProgramData\Python*",
                  "C:\Users\$env:USERNAME\AppData\Local\Programs\Python\Python*"
                )
                
                foreach ($pathPattern in $pythonPaths) {
                  try {
                    $foundPython = Get-ChildItem -Path $pathPattern -Filter "python.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
                    if ($foundPython) {
                      $pythonDir = Split-Path $foundPython.FullName
                      $scriptsDir = Join-Path $pythonDir "Scripts"
                      
                      if ($env:GITHUB_PATH) {
                        echo "$pythonDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                        echo "$scriptsDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                      }
                      
                      Write-Host "Found Python at: $($foundPython.FullName)"
                      $pythonCmd = $foundPython.FullName
                      break
                    }
                  } catch {
                    # Continue searching
                  }
                }
              }
            }
          }
          
          # Verify Python is accessible
          Write-Host "Verifying Python access:"
          if ($pythonCmd) {
            # Use the found Python command (could be "py", "python", or full path)
            $versionCheck = & $pythonCmd --version 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "Python version: $versionCheck"
              $pipResult = & $pythonCmd -m pip --version 2>&1
              if ($LASTEXITCODE -ne 0) {
                Write-Host "Warning: pip not accessible via $pythonCmd -m pip, but continuing..."
                Write-Host "pip output: $pipResult"
              } else {
                Write-Host "pip is accessible via $pythonCmd"
              }
            } else {
              Write-Host "::error::Python found but --version failed: $versionCheck"
              exit 1
            }
          } else {
            Write-Host "::error::Python not found via py launcher, python command, Get-Command, or common locations"
            Write-Host "Searched locations:"
            Write-Host "  - PATH (via Get-Command)"
            Write-Host "  - C:\Python*"
            Write-Host "  - ${env:ProgramFiles}\Python*"
            Write-Host "  - ${env:ProgramFiles(x86)}\Python*"
            Write-Host "  - ${env:LOCALAPPDATA}\Programs\Python\Python*"
            Write-Host "  - C:\ProgramData\Python*"
            Write-Host "  - C:\Users\$env:USERNAME\AppData\Local\Programs\Python\Python*"
            exit 1
          }
          
          # Store python command for use in later steps
          Write-Host "PYTHON_CMD=$pythonCmd" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Install dependencies
        shell: powershell
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\install_dependencies.ps1

      - name: Install project in editable mode
        shell: powershell
        run: |
          Write-Host "Installing project in editable mode..."
          # Use Python command from previous step (stored in GITHUB_ENV)
          $pythonCmd = $env:PYTHON_CMD
          if ([string]::IsNullOrEmpty($pythonCmd)) {
            # Fallback: try to find Python again
            $testPy = py --version 2>&1
            if ($LASTEXITCODE -eq 0) {
              $pythonCmd = "py"
            } else {
              $testPython = python --version 2>&1
              if ($LASTEXITCODE -eq 0) {
                $pythonCmd = "python"
              } else {
                Write-Host "::error::Python command not found and not set in GITHUB_ENV"
                exit 1
              }
            }
          }
          Write-Host "Using Python command: $pythonCmd"
          & $pythonCmd -m pip install -e .
          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Failed to install project in editable mode"
            exit 1
          }
          Write-Host "Project installed successfully"

      - name: Upload pip install logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-install-logs
          path: |
            pip-install-*.log
          retention-days: 5
          if-no-files-found: ignore

      - name: Preflight – check Focus availability
        id: preflight
        shell: powershell
        continue-on-error: true
        run: |
          # Ensure reports directory exists so preflight can write JUnit XML
          New-Item -ItemType Directory -Force -Path reports | Out-Null

          # Initialize outputs with defaults
          echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          echo "status=000" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          # Build base URL
          $BASE = "https://$env:FOCUS_SERVER_HOST$env:FOCUS_API_PREFIX"
          Write-Host "Checking $BASE/channels"
          Write-Host "FOCUS_SERVER_HOST: $env:FOCUS_SERVER_HOST"
          Write-Host "FOCUS_SERVER_PORT: $($env:FOCUS_SERVER_PORT -replace '^$', '(not used - HTTPS default)')"
          Write-Host "REQUIRE_SERVER: $env:REQUIRE_SERVER"
          Write-Host ""
          Write-Host "Network diagnostics:"
          Write-Host "  Hostname: $env:COMPUTERNAME"
          Write-Host "  User: $env:USERNAME"
          Write-Host ""
          Write-Host "Testing HTTP connection with curl.exe:"
          Write-Host "  URL: $BASE/channels"
          
          try {
            # Use curl.exe which works reliably with TLS on PowerShell 5.1
            $curlOutput = curl.exe -k -s -w "`n%{http_code}" "$BASE/channels" 2>&1
            if ($LASTEXITCODE -eq 0) {
              # Split output: last line is status code, rest is response
              $lines = $curlOutput -split "`n"
              $code = $lines[-1].Trim()
              $responseBody = ($lines[0..($lines.Length-2)] -join "`n").Trim()
              
              if ($code -match '^\d{3}$' -and [int]$code -ge 200 -and [int]$code -lt 400) {
                Write-Host "  [OK] HTTP request succeeded with HTTP $code"
                Write-Host "  Response: $($responseBody.Substring(0, [Math]::Min(100, $responseBody.Length)))"
                echo "reachable=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
                echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
                Write-Host "[OK] Focus server is reachable"
              } else {
                echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
                echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
                Write-Host "[FAIL] Focus server unreachable (HTTP $code)"
              }
            } else {
              throw "curl.exe failed with exit code: $LASTEXITCODE"
            }
          } catch {
            $code = "000"
            echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            Write-Host "[FAIL] Focus server unreachable (Connection failed)"
            Write-Host "  Error: $($_.Exception.Message)"
            
            if ($env:REQUIRE_SERVER -eq "true") {
              Write-Host "::error::Focus server unreachable. Server must be accessible for load and performance tests."
            }
          }
          
          Write-Host ""
          Write-Host "Final HTTP status code: $code"

      - name: Run load and performance tests
        shell: powershell
        run: |
          $FOCUS_URL = "$env:FOCUS_SERVER_HOST$env:FOCUS_API_PREFIX"
          Write-Host "FOCUS: https://$FOCUS_URL  VERIFY_SSL=$env:VERIFY_SSL"
          
          # Get reachable status
          $REACHABLE = "${{ steps.preflight.outputs.reachable }}"
          if ([string]::IsNullOrEmpty($REACHABLE)) {
            $REACHABLE = "false"
          }
          Write-Host "Server reachable: $REACHABLE"
          Write-Host "Require server: $env:REQUIRE_SERVER"
          
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          # Fail if server is unreachable and REQUIRE_SERVER=true
          if ($REACHABLE -ne "true" -and $env:REQUIRE_SERVER -eq "true") {
            Write-Host "::error::Server unreachable and REQUIRE_SERVER=true - cannot run load and performance tests"
            $xmlContent = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="load-performance" tests="0" failures="0" errors="1" skipped="0" time="0"><testcase name="server_unreachable" classname="preflight"><error message="Server unreachable and REQUIRE_SERVER=true" type="ConnectionError">Server unreachable and REQUIRE_SERVER=true</error></testcase></testsuite>'
            $xmlContent | Out-File -FilePath reports/junit-load-performance.xml -Encoding utf8
            exit 1
          }
          
          # Skip tests if server unreachable and REQUIRE_SERVER=false
          if ($REACHABLE -ne "true") {
            Write-Host "✗ Server unreachable - skipping load and performance tests"
            $xmlContent = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="load-performance" tests="0" failures="0" errors="0" skipped="1" time="0"><testcase name="server_unreachable" classname="preflight"><skipped message="Server unreachable"/></testcase></testsuite>'
            $xmlContent | Out-File -FilePath reports/junit-load-performance.xml -Encoding utf8
            exit 0
          }
          
          # Run load and performance tests (excluding UI tests that require playwright)
          # Runs all tests with @pytest.mark.load or @pytest.mark.performance markers
          # Skip health check for load/performance tests - they only need Focus Server API (already checked in preflight)
          # Use Python command from setup step
          $pythonCmd = $env:PYTHON_CMD
          if ([string]::IsNullOrEmpty($pythonCmd)) {
            # Fallback: try to find Python again
            $testPy = py --version 2>&1
            if ($LASTEXITCODE -eq 0) {
              $pythonCmd = "py"
            } else {
              $testPython = python --version 2>&1
              if ($LASTEXITCODE -eq 0) {
                $pythonCmd = "python"
              } else {
                Write-Host "::error::Python command not found"
                exit 1
              }
            }
          }
          Write-Host "Running tests with Python: $pythonCmd"
          & $pythonCmd -m pytest be_focus_server_tests/ `
            -m "load or performance" `
            --env staging `
            --ignore=be_focus_server_tests/ui `
            --skip-health-check `
            --monitor-pods `
            -v `
            --junitxml=reports/junit-load-performance.xml `
            --html=reports/load-performance-report.html `
            --self-contained-html `
            --json-report `
            --json-report-file=reports/load-performance-report.json

      - name: Generate console summary
        if: always()
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "========================================"
          Write-Host "LOAD AND PERFORMANCE TEST EXECUTION SUMMARY"
          Write-Host "========================================"
          if (Test-Path "reports/junit-load-performance.xml") {
            # Use Python command from setup step
            $pythonCmd = $env:PYTHON_CMD
            if ([string]::IsNullOrEmpty($pythonCmd)) {
              # Fallback: try to find Python again
              $testPy = py --version 2>&1
              if ($LASTEXITCODE -eq 0) {
                $pythonCmd = "py"
              } else {
                $testPython = python --version 2>&1
                if ($LASTEXITCODE -eq 0) {
                  $pythonCmd = "python"
                } else {
                  Write-Host "::error::Python command not found"
                  exit 1
                }
              }
            }
            & $pythonCmd scripts/parse_junit_xml.py reports/junit-load-performance.xml
            Write-Host "========================================"
            Write-Host ""
          } else {
            Write-Host "No test results found"
            Write-Host "========================================"
            Write-Host ""
          }

      - name: Publish Test Results
        id: test-reporter
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Pytest Results - Load and Performance Tests
          path: reports/junit-*.xml
          path-replace-backslashes: true
          reporter: java-junit
          list-suites: all
          list-tests: all
          max-annotations: 50
          fail-on-error: false
          only-summary: false
          working-directory: ${{ github.workspace }}

      - name: Upload test reports
        if: always()
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: load-performance-test-reports
          path: |
            reports/junit-*.xml
            reports/*.html
            reports/*.json
          retention-days: 7
          if-no-files-found: warn

      - name: Generate GitHub Actions summary
        if: always()
        shell: powershell
        env:
          ARTIFACT_DOWNLOAD_URL: ${{ steps.upload-artifact.outputs.url }}
        run: |
          $summaryPath = $env:GITHUB_STEP_SUMMARY
          if ([string]::IsNullOrEmpty($summaryPath)) {
            Write-Host "GITHUB_STEP_SUMMARY not set, skipping summary generation"
            exit 0
          }
          
          # Use Python command from setup step
          $pythonCmd = $env:PYTHON_CMD
          if ([string]::IsNullOrEmpty($pythonCmd)) {
            # Fallback: try to find Python again
            $testPy = py --version 2>&1
            if ($LASTEXITCODE -eq 0) {
              $pythonCmd = "py"
            } else {
              $testPython = python --version 2>&1
              if ($LASTEXITCODE -eq 0) {
                $pythonCmd = "python"
              } else {
                Write-Host "::error::Python command not found"
                exit 1
              }
            }
          }
          & $pythonCmd scripts/generate_github_summary.py reports/junit-load-performance.xml
