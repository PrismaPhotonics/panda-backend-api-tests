name: Upload Test Results to Xray

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Run nightly at 2 AM Israel time (midnight UTC)
    - cron: '0 0 * * *'

jobs:
  test-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # Install dependencies in stages to avoid resolution conflicts
          # Stage 1: Core pytest packages
          pip install --no-cache-dir --prefer-binary \
            pytest==8.2.0 \
            pytest-asyncio==0.23.0 \
            pytest-timeout==2.3.0 \
            pytest-mock==3.14.0 \
            pytest-html==4.1.1 \
            pytest-cov==5.0.0 \
            pytest-json-report==1.5.0 \
            pytest-xdist==3.6.0
          # Stage 2: HTTP and data processing
          pip install --no-cache-dir --prefer-binary \
            requests==2.32.3 \
            httpx==0.27.0 \
            beautifulsoup4==4.12.3 \
            pydantic==2.9.0 \
            pydantic-settings==2.5.0 \
            orjson==3.10.0 \
            pyyaml==6.0.1
          # Stage 3: Infrastructure and utilities
          pip install --no-cache-dir --prefer-binary \
            kubernetes==30.1.0 \
            pymongo==4.10.0 \
            paramiko==3.5.0 \
            pika==1.3.2 \
            structlog==24.4.0 \
            colorlog==6.8.2 \
            python-dateutil==2.9.0 \
            pytz==2024.1 \
            psutil==5.9.8 \
            python-dotenv==1.0.1 \
            netaddr==0.10.1 \
            jira==3.10.5
          # Stage 4: Browser automation (problematic packages)
          pip install --no-cache-dir --prefer-binary \
            playwright==1.48.0 \
            pytest-playwright==0.4.3 || true
          # Stage 5: Reporting and optional packages
          pip install --no-cache-dir --prefer-binary \
            allure-pytest==2.13.2 \
            jinja2==3.1.4 \
            asyncio-mqtt==0.16.2 \
            aiofiles==24.1.0 \
            pytest-xray==0.2.1 || true
          # Stage 6: Development tools (optional, can fail)
          pip install --no-cache-dir --prefer-binary \
            black==24.8.0 \
            flake8==7.1.1 \
            mypy==1.11.0 \
            isort==5.13.2 \
            cryptography==43.0.0 \
            bandit==1.7.8 \
            sphinx==8.1.3 \
            sphinx-rtd-theme==3.0.2 || true
      
      - name: Run tests
        env:
          ENVIRONMENT: new_production
        run: |
          pytest be_focus_server_tests/ \
            --xray \
            --junitxml=reports/junit.xml \
            --html=reports/report.html \
            --self-contained-html
      
      - name: Upload to Xray
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
        run: |
          python scripts/xray_upload.py --format auto
      
      - name: Upload test results as artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: |
            reports/
            logs/
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('reports/xray-exec.json', 'utf8');
            const results = JSON.parse(report);
            const passed = results.tests.filter(t => t.status === 'PASSED').length;
            const total = results.tests.length;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ§ª Test Results
            
            âœ… **Passed:** ${passed} / ${total}
            âŒ **Failed:** ${total - passed}
            
            [View details in Xray](https://yoursite.atlassian.net/)
            `
            });

