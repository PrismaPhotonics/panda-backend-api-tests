name: Focus API Contract Tests

on:
  push:
    branches: [ main, develop, "**/feature/**", "**/chore/**" ]
  pull_request:
  workflow_dispatch:
    inputs:
      require_server:
        description: "Fail if Focus server is unreachable"
        default: "true"
        type: choice
        options: [ "true", "false" ]

jobs:
  contract:
    # If internal network is required, set to self-hosted
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      # Defaults; prefer to set as Secrets
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.150' }}
      FOCUS_SERVER_PORT: ${{ secrets.FOCUS_SERVER_PORT || '30443' }}
      FOCUS_API_PREFIX: ${{ secrets.FOCUS_API_PREFIX || '/focus-server' }}
      VERIFY_SSL: ${{ secrets.VERIFY_SSL || 'false' }}
      # Control preflight strictness across all triggers (push/PR/dispatch)
      # Input takes precedence when present; otherwise use secret or default false
      REQUIRE_SERVER: ${{ inputs.require_server || secrets.REQUIRE_SERVER || 'false' }}
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pytest requests urllib3 pytest-sugar
          fi

      - name: Preflight + pytest (composite)
        uses: ./.github/actions/focus-preflight-run
        with:
          base_url: https://${{ env.FOCUS_SERVER_HOST }}:${{ env.FOCUS_SERVER_PORT }}
          api_prefix: ${{ env.FOCUS_API_PREFIX }}
          verify_ssl: ${{ env.VERIFY_SSL }}
          require_server: ${{ env.REQUIRE_SERVER }}
          retries: '3'
          connect_timeout: '5'
          test_path: focus_server_api_load_tests/focus_api_tests/test_api_contract.py
          junit_path: reports/junit.xml

      - name: Run contract tests (echo context)
        run: |
          echo "FOCUS: $FOCUS_SERVER_HOST:$FOCUS_SERVER_PORT$FOCUS_API_PREFIX  VERIFY_SSL=$VERIFY_SSL REQUIRE_SERVER=$REQUIRE_SERVER"

      - name: Upload test report (junit)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: reports/junit.xml


