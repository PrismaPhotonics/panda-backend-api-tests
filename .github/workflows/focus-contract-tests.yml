name: Focus API Contract Tests

on:
  push:
    branches: [ main, develop, "**/feature/**", "**/chore/**" ]
  pull_request:
  workflow_dispatch:
    inputs:
      require_server:
        description: "Fail if Focus server is unreachable"
        default: "true"
        type: choice
        options: [ "true", "false" ]

jobs:
  contract:
    # If internal network is required, set to self-hosted
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      # Defaults; prefer to set as Secrets
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.150' }}
      FOCUS_SERVER_PORT: ${{ secrets.FOCUS_SERVER_PORT || '30443' }}
      FOCUS_API_PREFIX: ${{ secrets.FOCUS_API_PREFIX || '/focus-server' }}
      VERIFY_SSL: ${{ secrets.VERIFY_SSL || 'false' }}
      # Control preflight strictness across all triggers (push/PR/dispatch)
      # Input takes precedence when present; otherwise use secret or default false
      REQUIRE_SERVER: ${{ inputs.require_server || secrets.REQUIRE_SERVER || 'false' }}
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install -U pip setuptools wheel
          if [ -f requirements.txt ]; then
            # Install dependencies in stages to avoid resolution conflicts
            # Stage 1: Core pytest packages
            pip install --no-cache-dir --prefer-binary \
              pytest==8.2.0 \
              pytest-asyncio==0.23.0 \
              pytest-timeout==2.3.0 \
              pytest-mock==3.14.0 \
              pytest-html==4.1.1 \
              pytest-cov==5.0.0 \
              pytest-json-report==1.5.0 \
              pytest-xdist==3.6.0
            # Stage 2: HTTP and data processing
            pip install --no-cache-dir --prefer-binary \
              requests==2.32.3 \
              httpx==0.27.0 \
              beautifulsoup4==4.12.3 \
              pydantic==2.9.0 \
              pydantic-settings==2.5.0 \
              orjson==3.10.0 \
              pyyaml==6.0.1
            # Stage 3: Infrastructure and utilities
            pip install --no-cache-dir --prefer-binary \
              kubernetes==30.1.0 \
              pymongo==4.10.0 \
              paramiko==3.5.0 \
              pika==1.3.2 \
              structlog==24.4.0 \
              colorlog==6.8.2 \
              python-dateutil==2.9.0 \
              pytz==2024.1 \
              psutil==5.9.8 \
              python-dotenv==1.0.1 \
              netaddr==0.10.1 \
              jira==3.10.5
            # Stage 4: Browser automation (problematic packages)
            pip install --no-cache-dir --prefer-binary \
              playwright==1.48.0 \
              pytest-playwright==0.4.3 || true
            # Stage 5: Reporting and optional packages
            pip install --no-cache-dir --prefer-binary \
              allure-pytest==2.13.2 \
              jinja2==3.1.4 \
              asyncio-mqtt==0.16.2 \
              aiofiles==24.1.0 \
              pytest-xray==0.2.1 || true
            # Stage 6: Development tools (optional, can fail)
            pip install --no-cache-dir --prefer-binary \
              black==24.8.0 \
              flake8==7.1.1 \
              mypy==1.11.0 \
              isort==5.13.2 \
              cryptography==43.0.0 \
              bandit==1.7.8 \
              sphinx==8.1.3 \
              sphinx-rtd-theme==3.0.2 || true
          else
            pip install pytest requests urllib3 pytest-sugar
          fi

      - name: Preflight â€“ check Focus availability
        id: preflight
        shell: bash
        run: |
          BASE="https://${FOCUS_SERVER_HOST}:${FOCUS_SERVER_PORT}${FOCUS_API_PREFIX}"
          echo "Checking $BASE/channels"
          set +e
          code=$(curl -sk -o /dev/null -w "%{http_code}" "$BASE/channels")
          echo "status=$code" >> $GITHUB_OUTPUT
          # reachable=true for 2xx/3xx
          if [[ "$code" -ge 200 && "$code" -lt 400 ]]; then
            echo "reachable=true" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "reachable=false" >> $GITHUB_OUTPUT
            if [[ "${REQUIRE_SERVER}" == "true" ]]; then
              echo "::error::Focus server unreachable (HTTP $code)"
              exit 1
            fi
            # allow job to continue when require_server=false
            exit 0
          fi

      - name: Debug curl (unreachable)
        if: ${{ steps.preflight.outputs.reachable != 'true' }}
        shell: bash
        run: |
          BASE="https://${FOCUS_SERVER_HOST}:${FOCUS_SERVER_PORT}${FOCUS_API_PREFIX}"
          echo "Diagnostic curl -vk $BASE/channels"
          curl -vk "$BASE/channels" || true

      - name: Run contract tests
        if: ${{ steps.preflight.outputs.reachable == 'true' }}
        run: |
          echo "FOCUS: $FOCUS_SERVER_HOST:$FOCUS_SERVER_PORT$FOCUS_API_PREFIX  VERIFY_SSL=$VERIFY_SSL"
          pytest -q focus_server_api_load_tests/focus_api_tests/test_api_contract.py \
            --junitxml=reports/junit.xml

      - name: Upload test report (junit)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: reports/junit.xml


