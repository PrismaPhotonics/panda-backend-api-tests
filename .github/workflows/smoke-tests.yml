name: Smoke Tests

on:
  push:
    branches: [ main, develop, master, "chore/add-roy-tests" ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      require_server:
        description: "Fail if Focus server is unreachable"
        default: "true"
        type: choice
        options: [ "true", "false" ]

env:
  PYTHON_VERSION: '3.12'

jobs:
  smoke:
    # IMPORTANT: Use self-hosted Windows runner for production environment access
    # Cloud runners cannot access internal network (10.10.10.100)
    runs-on: [self-hosted, Windows]
    timeout-minutes: 15

    env:
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.100' }}
      FOCUS_SERVER_PORT: ${{ secrets.FOCUS_SERVER_PORT || '' }}
      FOCUS_API_PREFIX: ${{ secrets.FOCUS_API_PREFIX || '/focus-server' }}
      VERIFY_SSL: ${{ secrets.VERIFY_SSL || 'false' }}
      REQUIRE_SERVER: ${{ inputs.require_server || secrets.REQUIRE_SERVER || 'true' }}
      ENVIRONMENT: ${{ secrets.ENVIRONMENT || 'new_production' }}
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        shell: powershell
        run: |
          python -m pip install -U pip setuptools wheel
          
          Write-Host "Installing dependencies..."
          
          # Install core testing framework (pytest 9.0.1 first)
          pip install --no-cache-dir --prefer-binary `
            pytest==9.0.1 pytest-asyncio pytest-timeout pytest-mock pytest-html pytest-cov pytest-json-report pytest-xdist
          
          # Install HTTP and data processing
          pip install --no-cache-dir --prefer-binary `
            requests httpx beautifulsoup4 pydantic pydantic-settings orjson pyyaml
          
          # Install infrastructure packages
          pip install --no-cache-dir --prefer-binary `
            kubernetes pymongo paramiko pika structlog colorlog python-dateutil pytz psutil python-dotenv netaddr
          
          # Install optional packages
          pip install --no-cache-dir --prefer-binary `
            allure-pytest jinja2 asyncio-mqtt aiofiles || echo "Some optional packages failed"
          
          Write-Host "Dependency installation completed!"
          pip list | Select-Object -First 40

      - name: Preflight – check Focus availability
        id: preflight
        shell: powershell
        continue-on-error: true
        run: |
          # Initialize outputs with defaults
          echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          echo "status=000" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          # Build base URL
          $BASE = "https://$env:FOCUS_SERVER_HOST$env:FOCUS_API_PREFIX"
          Write-Host "Checking $BASE/channels"
          Write-Host "FOCUS_SERVER_HOST: $env:FOCUS_SERVER_HOST"
          Write-Host "FOCUS_SERVER_PORT: $($env:FOCUS_SERVER_PORT -replace '^$', '(not used - HTTPS default)')"
          Write-Host "REQUIRE_SERVER: $env:REQUIRE_SERVER"
          Write-Host ""
          Write-Host "Network diagnostics:"
          Write-Host "  Hostname: $env:COMPUTERNAME"
          Write-Host "  User: $env:USERNAME"
          Write-Host ""
          Write-Host "Testing HTTP connection:"
          Write-Host "  URL: $BASE/channels"
          
          try {
            # Try Invoke-WebRequest with increased timeout
            $response = Invoke-WebRequest -Uri "$BASE/channels" -Method Get -SkipCertificateCheck -TimeoutSec 30 -ErrorAction Stop
            $code = $response.StatusCode
            
            if ($code -ge 200 -and $code -lt 400) {
              Write-Host "  ✓ Curl command succeeded with HTTP $code"
              Write-Host "  Response: $($response.Content.Substring(0, [Math]::Min(100, $response.Content.Length)))"
              echo "reachable=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              Write-Host "✓ Focus server is reachable"
            } else {
              echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              Write-Host "✗ Focus server unreachable (HTTP $code)"
            }
          } catch {
            $code = "000"
            echo "reachable=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            echo "status=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            Write-Host "✗ Focus server unreachable (Connection failed)"
            Write-Host "  Error: $($_.Exception.Message)"
            
            if ($env:REQUIRE_SERVER -eq "true") {
              Write-Host "::error::Focus server unreachable. Server must be accessible for smoke tests."
            }
          }
          
          Write-Host ""
          Write-Host "Final HTTP status code: $code"

      - name: Run smoke tests
        shell: powershell
        run: |
          $FOCUS_URL = "$env:FOCUS_SERVER_HOST$env:FOCUS_API_PREFIX"
          Write-Host "FOCUS: https://$FOCUS_URL  VERIFY_SSL=$env:VERIFY_SSL"
          
          # Get reachable status
          $REACHABLE = "${{ steps.preflight.outputs.reachable }}"
          if ([string]::IsNullOrEmpty($REACHABLE)) {
            $REACHABLE = "false"
          }
          Write-Host "Server reachable: $REACHABLE"
          Write-Host "Require server: $env:REQUIRE_SERVER"
          
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          # Fail if server is unreachable and REQUIRE_SERVER=true
          if ($REACHABLE -ne "true" -and $env:REQUIRE_SERVER -eq "true") {
            Write-Host "::error::Server unreachable and REQUIRE_SERVER=true - cannot run smoke tests"
            $xmlContent = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="smoke" tests="0" failures="0" errors="1" skipped="0" time="0"><testcase name="server_unreachable" classname="preflight"><error message="Server unreachable and REQUIRE_SERVER=true" type="ConnectionError">Server unreachable and REQUIRE_SERVER=true</error></testcase></testsuite>'
            $xmlContent | Out-File -FilePath reports/junit-smoke.xml -Encoding utf8
            exit 1
          }
          
          # Skip tests if server unreachable and REQUIRE_SERVER=false
          if ($REACHABLE -ne "true") {
            Write-Host "✗ Server unreachable - skipping smoke tests"
            $xmlContent = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="smoke" tests="0" failures="0" errors="0" skipped="1" time="0"><testcase name="server_unreachable" classname="preflight"><skipped message="Server unreachable"/></testcase></testsuite>'
            $xmlContent | Out-File -FilePath reports/junit-smoke.xml -Encoding utf8
            exit 0
          }
          
          # Run smoke tests
          pytest be_focus_server_tests/ `
            -m "smoke" `
            -v `
            --maxfail=10 `
            --junitxml=reports/junit-smoke.xml `
            --html=reports/smoke-report.html `
            --self-contained-html `
            --json-report `
            --json-report-file=reports/smoke-report.json

      - name: Generate console summary
        if: always()
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "========================================"
          Write-Host "SMOKE TEST EXECUTION SUMMARY"
          Write-Host "========================================"
          if (Test-Path "reports/junit-smoke.xml") {
            python scripts/parse_junit_xml.py reports/junit-smoke.xml
            Write-Host "========================================"
            Write-Host ""
          } else {
            Write-Host "No test results found"
            Write-Host "========================================"
            Write-Host ""
          }

      - name: Upload test reports
        if: always()
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-reports
          path: |
            reports/junit-*.xml
            reports/*.html
            reports/*.json
          retention-days: 7
          if-no-files-found: warn

      - name: Generate GitHub Actions summary
        if: always()
        shell: powershell
        env:
          ARTIFACT_DOWNLOAD_URL: ${{ steps.upload-artifact.outputs.url }}
        run: |
          $summaryPath = $env:GITHUB_STEP_SUMMARY
          if ([string]::IsNullOrEmpty($summaryPath)) {
            Write-Host "GITHUB_STEP_SUMMARY not set, skipping summary generation"
            exit 0
          }
          
          python scripts/generate_github_summary.py reports/junit-smoke.xml

