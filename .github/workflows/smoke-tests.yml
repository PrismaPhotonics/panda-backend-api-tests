name: Smoke Tests

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner to use (self-hosted or github-hosted)'
        required: false
        default: 'github-hosted'
        type: choice
        options:
          - github-hosted
          - self-hosted

env:
  PYTHON_VERSION: '3.10'

jobs:
  smoke-tests:
    name: Smoke Tests
    runs-on: ${{ github.event.inputs.runner == 'self-hosted' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential curl

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        
        echo "Installing dependencies for smoke tests..."
        
        # Install core testing framework
        pip install --no-cache-dir --prefer-binary \
          pytest pytest-asyncio pytest-timeout pytest-mock pytest-html pytest-cov pytest-json-report pytest-xdist
        
        # Install HTTP and data processing
        pip install --no-cache-dir --prefer-binary \
          requests httpx beautifulsoup4 pydantic pydantic-settings orjson pyyaml
        
        # Install infrastructure packages
        pip install --no-cache-dir --prefer-binary \
          kubernetes pymongo paramiko pika structlog colorlog python-dateutil pytz psutil python-dotenv netaddr
        
        echo "Dependency installation completed!"

    - name: Create reports directory
      run: mkdir -p reports

    - name: Check Focus Server availability
      id: check_focus
      env:
        FOCUS_BASE_URL: ${{ secrets.FOCUS_BASE_URL }}
        FOCUS_API_PREFIX: ${{ secrets.FOCUS_API_PREFIX || '/focus-server' }}
      run: |
        if [ -z "$FOCUS_BASE_URL" ]; then
          echo "available=false" >> $GITHUB_OUTPUT
          echo "FOCUS_BASE_URL secret not configured - smoke tests requiring Focus Server will be skipped"
        else
          BASE="${FOCUS_BASE_URL%/}${FOCUS_API_PREFIX}"
          code=$(curl -sk -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 "$BASE/ack" 2>/dev/null || echo "000")
          if [[ "$code" -ge 200 && "$code" -lt 500 ]]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "Focus Server is reachable (HTTP $code)"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "Focus Server not reachable (HTTP $code) - smoke tests will be skipped"
          fi
        fi

    - name: Set PYTHONPATH
      run: |
        echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
        echo "PYTHONPATH set to: ${{ github.workspace }}"

    - name: Verify test collection
      env:
        CI: true
        FOCUS_ENV: local
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "Verifying pytest can collect smoke tests..."
        pytest be_focus_server_tests/ \
          --env=local \
          --skip-health-check \
          --skip-sanity-check \
          -m "smoke" \
          --collect-only \
          -q || echo "Collection check completed with warnings"

    - name: Run Smoke Tests
      env:
        CI: true
        FOCUS_ENV: local
        PYTHONPATH: ${{ github.workspace }}
        FOCUS_BASE_URL: ${{ secrets.FOCUS_BASE_URL }}
        FOCUS_API_PREFIX: ${{ secrets.FOCUS_API_PREFIX || '/focus-server' }}
        VERIFY_SSL: ${{ secrets.VERIFY_SSL || 'false' }}
        FOCUS_SERVER_AVAILABLE: ${{ steps.check_focus.outputs.available }}
      continue-on-error: false
      run: |
        echo "=========================================="
        echo "üî• Running Smoke Tests"
        echo "=========================================="
        echo "Focus Server Available: ${{ steps.check_focus.outputs.available }}"
        echo "FOCUS_BASE_URL: ${FOCUS_BASE_URL:-'Not configured'}"
        echo "FOCUS_ENV: ${FOCUS_ENV}"
        echo "=========================================="
        
        set +e
        pytest be_focus_server_tests/ \
          --env=local \
          --skip-health-check \
          --skip-sanity-check \
          -m "smoke" \
          -v \
          --tb=short \
          --junitxml=reports/junit-smoke.xml \
          --html=reports/smoke-report.html \
          --self-contained-html \
          --maxfail=5 \
          --continue-on-collection-errors
        exit_code=$?
        set -e
        
        echo ""
        echo "=========================================="
        echo "üìä Test Execution Summary"
        echo "=========================================="
        echo "Exit Code: $exit_code"
        
        if [ $exit_code -eq 2 ]; then
          echo "‚ö†Ô∏è Pytest exit code 2 - collection or configuration error"
          echo "Attempting to collect tests for debugging..."
          pytest be_focus_server_tests/ -m "smoke" --collect-only -v || true
          exit 2
        elif [ $exit_code -eq 5 ]; then
          echo "‚ö†Ô∏è No tests collected (exit code 5)"
          echo "This might be expected if no tests match the 'smoke' marker"
          exit 0
        elif [ $exit_code -eq 1 ]; then
          echo "‚ùå Some tests failed (exit code 1)"
          echo "Check the test reports in artifacts for details"
          if [ -f reports/junit-smoke.xml ]; then
            echo ""
            echo "Quick summary from JUnit XML:"
            python3 << 'PYTHON_SCRIPT'
import xml.etree.ElementTree as ET
import sys
try:
    tree = ET.parse('reports/junit-smoke.xml')
    root = tree.getroot()
    tests = int(root.get('tests', 0))
    failures = int(root.get('failures', 0))
    errors = int(root.get('errors', 0))
    skipped = int(root.get('skipped', 0))
    print(f'Total tests: {tests}')
    print(f'Failed: {failures}')
    print(f'Errors: {errors}')
    print(f'Skipped: {skipped}')
    print(f'Passed: {tests - failures - errors - skipped}')
except Exception as e:
    print(f'Could not parse JUnit XML: {e}')
PYTHON_SCRIPT
          fi
          exit 1
        else
          echo "‚úÖ All tests passed!"
          exit 0
        fi

    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-reports
        path: |
          reports/junit-smoke.xml
          reports/smoke-report.html
        retention-days: 7

    - name: Comment PR with results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let summary = '## üî• Smoke Tests Results\n\n';
          
          try {
            if (fs.existsSync('reports/junit-smoke.xml')) {
              summary += '‚úÖ Smoke tests completed. Check artifacts for detailed reports.\n';
            } else {
              summary += '‚ö†Ô∏è Smoke test reports not found.\n';
            }
          } catch (error) {
            summary += `‚ö†Ô∏è Error reading reports: ${error.message}\n`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
