name: Job Load Tests (Live & Historic)

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: "Test type to run"
        type: choice
        options:
          - all
          - live
          - historic
        default: "all"
      load_level:
        description: "Load level"
        type: choice
        options:
          - basic
          - heavy
          - stress
        default: "basic"
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  pull_request:
    branches: [main]
    paths:
      - 'be_focus_server_tests/load/**'
      - 'src/apis/grpc_client.py'
      - 'src/apis/focus_server_api.py'

env:
  PYTHON_VERSION: '3.13'

jobs:
  # =========================================================================
  # Live Job Tests
  # =========================================================================
  live-job-tests:
    if: ${{ inputs.test_type == 'all' || inputs.test_type == 'live' || inputs.test_type == '' }}
    runs-on: [self-hosted, windows, "panda_automation"]
    timeout-minutes: 20

    env:
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.100' }}
      VERIFY_SSL: 'false'
      ENVIRONMENT: 'staging'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        shell: powershell
        run: |
          $pythonCmd = if ((py --version 2>&1) -match "Python") { "py" } else { "python" }
          echo "PYTHON_CMD=$pythonCmd" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Install dependencies
        shell: powershell
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\install_dependencies.ps1
          & $env:PYTHON_CMD -m pip install -e . --quiet

      - name: Health Check
        shell: powershell
        run: |
          $url = "https://$env:FOCUS_SERVER_HOST/focus-server/ack"
          $result = curl.exe -k -s -w "%{http_code}" -o nul $url 2>&1
          if ($result -ne "200") { exit 1 }
          Write-Host "Server OK"

      - name: Run Live Job Tests (Basic)
        if: ${{ inputs.load_level == 'basic' || inputs.load_level == '' }}
        id: live-basic
        continue-on-error: true
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          Write-Host "========================================"
          Write-Host "üî¥ LIVE JOB TESTS - BASIC"
          Write-Host "========================================"
          
          # Ensure XML file exists even if pytest fails early (e.g., health check failure)
          $xmlFile = "reports/junit-live-basic.xml"
          $exitCode = 1  # Default to failure
          
          try {
            & $env:PYTHON_CMD -m pytest `
              be_focus_server_tests/load/test_live_load.py `
              -m "live and not heavy and not stress" `
              --env staging `
              --skip-health-check `
              -v `
              --tb=short `
              --log-cli-level=INFO `
              --junitxml=$xmlFile 2>&1 | Tee-Object -Variable pytestOutput
            
            $exitCode = $LASTEXITCODE
            Write-Host "Pytest exit code: $exitCode"
            Write-Host "Pytest output: $pytestOutput"
          } catch {
            Write-Host "::error::Pytest execution failed: $_"
            $exitCode = 1
          } finally {
            # Always ensure XML file exists (create empty one if pytest failed before creating it)
            if (-not (Test-Path $xmlFile)) {
              Write-Host "::warning::No XML file created - creating empty one to indicate failure"
              $emptyXml = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="live-basic" tests="0" failures="0" errors="1" skipped="0" time="0"><testcase name="pytest_execution_failed" classname="pytest"><error message="Pytest failed before tests could run (possibly health check or collection error)" type="ExecutionError">Pytest failed before tests could run</error></testcase></testsuite>'
              $emptyXml | Out-File -FilePath $xmlFile -Encoding utf8 -Force
              Write-Host "Created empty XML file: $xmlFile"
            } else {
              Write-Host "XML file exists: $xmlFile"
            }
            
            # Store exit code for later checking
            echo "EXIT_CODE=$exitCode" | Out-File -FilePath "reports/live-basic-exit-code.txt" -Encoding utf8 -Force
          }
          
          exit $exitCode

      - name: Run Live Job Tests (Heavy)
        if: ${{ inputs.load_level == 'heavy' || inputs.load_level == 'stress' }}
        id: live-heavy
        continue-on-error: true
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          Write-Host "========================================"
          Write-Host "üî¥ LIVE JOB TESTS - HEAVY"
          Write-Host "========================================"
          
          $xmlFile = "reports/junit-live-heavy.xml"
          $exitCode = 1  # Default to failure
          
          try {
            & $env:PYTHON_CMD -m pytest `
              be_focus_server_tests/load/test_live_load.py `
              -m "live and heavy" `
              --env staging `
              --skip-health-check `
              -v `
              --tb=short `
              --log-cli-level=INFO `
              --junitxml=$xmlFile 2>&1 | Tee-Object -Variable pytestOutput
            
            $exitCode = $LASTEXITCODE
            Write-Host "Pytest exit code: $exitCode"
          } catch {
            Write-Host "::error::Pytest execution failed: $_"
            $exitCode = 1
          } finally {
            if (-not (Test-Path $xmlFile)) {
              Write-Host "::warning::No XML file created - creating empty one to indicate failure"
              $emptyXml = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="live-heavy" tests="0" failures="0" errors="1" skipped="0" time="0"><testcase name="pytest_execution_failed" classname="pytest"><error message="Pytest failed before tests could run" type="ExecutionError">Pytest failed before tests could run</error></testcase></testsuite>'
              $emptyXml | Out-File -FilePath $xmlFile -Encoding utf8 -Force
            }
            echo "EXIT_CODE=$exitCode" | Out-File -FilePath "reports/live-heavy-exit-code.txt" -Encoding utf8 -Force
          }
          
          exit $exitCode

      - name: Run Live Job Tests (Stress)
        if: ${{ inputs.load_level == 'stress' }}
        id: live-stress
        continue-on-error: true
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          Write-Host "========================================"
          Write-Host "üî¥ LIVE JOB TESTS - STRESS"
          Write-Host "========================================"
          
          $xmlFile = "reports/junit-live-stress.xml"
          $exitCode = 1  # Default to failure
          
          try {
            & $env:PYTHON_CMD -m pytest `
              be_focus_server_tests/load/test_live_load.py `
              -m "live and stress" `
              --env staging `
              --skip-health-check `
              -v `
              --tb=short `
              --log-cli-level=INFO `
              --junitxml=$xmlFile 2>&1 | Tee-Object -Variable pytestOutput
            
            $exitCode = $LASTEXITCODE
            Write-Host "Pytest exit code: $exitCode"
          } catch {
            Write-Host "::error::Pytest execution failed: $_"
            $exitCode = 1
          } finally {
            if (-not (Test-Path $xmlFile)) {
              Write-Host "::warning::No XML file created - creating empty one to indicate failure"
              $emptyXml = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="live-stress" tests="0" failures="0" errors="1" skipped="0" time="0"><testcase name="pytest_execution_failed" classname="pytest"><error message="Pytest failed before tests could run" type="ExecutionError">Pytest failed before tests could run</error></testcase></testsuite>'
              $emptyXml | Out-File -FilePath $xmlFile -Encoding utf8 -Force
            }
            echo "EXIT_CODE=$exitCode" | Out-File -FilePath "reports/live-stress-exit-code.txt" -Encoding utf8 -Force
          }
          
          exit $exitCode

      - name: Generate Comprehensive Test Reports (Live)
        if: always()
        shell: powershell
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          FOCUS_SERVER_HOST: ${{ env.FOCUS_SERVER_HOST }}
        run: |
          Write-Host "Generating comprehensive test reports for Live Job Tests..."
          $target = "https://$env:FOCUS_SERVER_HOST/focus-server"
          
          $junitFiles = @(
            "reports/junit-live-basic.xml",
            "reports/junit-live-heavy.xml",
            "reports/junit-live-stress.xml"
          )
          
          foreach ($file in $junitFiles) {
            if (Test-Path $file) {
              Write-Host "Processing: $file"
              py scripts/generate_comprehensive_test_report.py $file `
                --environment $env:ENVIRONMENT `
                --target $target
            }
          }

      - name: Check for Test Failures (Live)
        if: always()
        shell: powershell
        run: |
          Write-Host "========================================"
          Write-Host "Checking for test failures..."
          Write-Host "========================================"
          $hasFailures = $false
          $expectedFiles = @()
          
          # Determine which test files should exist based on load_level
          $loadLevel = '${{ inputs.load_level || 'basic' }}'
          if ($loadLevel -eq 'basic' -or $loadLevel -eq '') {
            $expectedFiles += "reports/junit-live-basic.xml"
          }
          if ($loadLevel -eq 'heavy' -or $loadLevel -eq 'stress') {
            $expectedFiles += "reports/junit-live-heavy.xml"
          }
          if ($loadLevel -eq 'stress') {
            $expectedFiles += "reports/junit-live-stress.xml"
          }
          
          Write-Host "Expected files for load_level '$loadLevel': $($expectedFiles -join ', ')"
          
          # Check exit codes from test steps (more reliable than step outcome with continue-on-error)
          if ($loadLevel -eq 'basic' -or $loadLevel -eq '') {
            if (Test-Path "reports/live-basic-exit-code.txt") {
              $exitCodeLine = Get-Content "reports/live-basic-exit-code.txt"
              if ($exitCodeLine -match "EXIT_CODE=(\d+)") {
                $exitCode = [int]$matches[1]
                Write-Host "Live Basic exit code: $exitCode"
                if ($exitCode -ne 0) {
                  Write-Host "::error::Live Basic tests exited with code $exitCode"
                  $hasFailures = $true
                }
              }
            } else {
              Write-Host "::warning::Exit code file not found for live-basic (step may not have run)"
            }
          }
          
          if ($loadLevel -eq 'heavy' -or $loadLevel -eq 'stress') {
            if (Test-Path "reports/live-heavy-exit-code.txt") {
              $exitCodeLine = Get-Content "reports/live-heavy-exit-code.txt"
              if ($exitCodeLine -match "EXIT_CODE=(\d+)") {
                $exitCode = [int]$matches[1]
                Write-Host "Live Heavy exit code: $exitCode"
                if ($exitCode -ne 0) {
                  Write-Host "::error::Live Heavy tests exited with code $exitCode"
                  $hasFailures = $true
                }
              }
            }
          }
          
          if ($loadLevel -eq 'stress') {
            if (Test-Path "reports/live-stress-exit-code.txt") {
              $exitCodeLine = Get-Content "reports/live-stress-exit-code.txt"
              if ($exitCodeLine -match "EXIT_CODE=(\d+)") {
                $exitCode = [int]$matches[1]
                Write-Host "Live Stress exit code: $exitCode"
                if ($exitCode -ne 0) {
                  Write-Host "::error::Live Stress tests exited with code $exitCode"
                  $hasFailures = $true
                }
              }
            }
          }
          
          # Check if expected XML files exist
          $xmlFound = $false
          foreach ($file in $expectedFiles) {
            if (Test-Path $file) {
              $xmlFound = $true
              Write-Host "Found: $file"
              
              # Parse XML for failures/errors
              try {
                $xml = [xml](Get-Content $file)
                $testsuite = if ($xml.testsuites) { $xml.testsuites.testsuite } else { $xml.testsuite }
                
                if ($testsuite) {
                  $failures = [int]$testsuite.failures
                  $errors = [int]$testsuite.errors
                  $tests = [int]$testsuite.tests
                  
                  Write-Host "  Tests: $tests, Failures: $failures, Errors: $errors"
                  
                  if ($failures -gt 0 -or $errors -gt 0) {
                    Write-Host "::error::Found failures in $file: $failures failures, $errors errors"
                    $hasFailures = $true
                  }
                }
              } catch {
                Write-Host "::warning::Could not parse XML file $file: $_"
              }
            } else {
              Write-Host "Missing expected file: $file"
            }
          }
          
          # If no XML files were found and tests were supposed to run, that's a failure
          if (-not $xmlFound -and $expectedFiles.Count -gt 0) {
            Write-Host "::error::No JUnit XML files found - tests did not execute or failed before generating reports"
            Write-Host "Expected at least one of: $($expectedFiles -join ', ')"
            $hasFailures = $true
          }
          
          Write-Host "========================================"
          if ($hasFailures) {
            Write-Host "::error::Live Job Tests failed - failing workflow"
            exit 1
          } else {
            Write-Host "‚úÖ All Live Job Tests passed"
          }

      - name: Upload Live Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: live-job-reports
          path: reports/junit-live-*.xml
          retention-days: 14
          if-no-files-found: warn

  # =========================================================================
  # Historic Job Tests
  # =========================================================================
  historic-job-tests:
    if: ${{ inputs.test_type == 'all' || inputs.test_type == 'historic' || inputs.test_type == '' }}
    runs-on: [self-hosted, windows, "panda_automation"]
    timeout-minutes: 25

    env:
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.100' }}
      VERIFY_SSL: 'false'
      ENVIRONMENT: 'staging'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        shell: powershell
        run: |
          $pythonCmd = if ((py --version 2>&1) -match "Python") { "py" } else { "python" }
          echo "PYTHON_CMD=$pythonCmd" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Install dependencies
        shell: powershell
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\install_dependencies.ps1
          & $env:PYTHON_CMD -m pip install -e . --quiet

      - name: Health Check
        shell: powershell
        run: |
          $url = "https://$env:FOCUS_SERVER_HOST/focus-server/ack"
          $result = curl.exe -k -s -w "%{http_code}" -o nul $url 2>&1
          if ($result -ne "200") { exit 1 }
          Write-Host "Server OK"

      - name: Run Historic Job Tests (Basic)
        if: ${{ inputs.load_level == 'basic' || inputs.load_level == '' }}
        id: historic-basic
        continue-on-error: true
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          Write-Host "========================================"
          Write-Host "üìº HISTORIC JOB TESTS - BASIC"
          Write-Host "========================================"
          
          # Ensure XML file exists even if pytest fails early (e.g., health check failure)
          $xmlFile = "reports/junit-historic-basic.xml"
          $exitCode = 1  # Default to failure
          
          try {
            & $env:PYTHON_CMD -m pytest `
              be_focus_server_tests/load/test_historic_load.py `
              -m "historic and not heavy and not stress" `
              --env staging `
              --skip-health-check `
              -v `
              --tb=short `
              --log-cli-level=INFO `
              --junitxml=$xmlFile 2>&1 | Tee-Object -Variable pytestOutput
            
            $exitCode = $LASTEXITCODE
            Write-Host "Pytest exit code: $exitCode"
            Write-Host "Pytest output: $pytestOutput"
          } catch {
            Write-Host "::error::Pytest execution failed: $_"
            $exitCode = 1
          } finally {
            # Always ensure XML file exists (create empty one if pytest failed before creating it)
            if (-not (Test-Path $xmlFile)) {
              Write-Host "::warning::No XML file created - creating empty one to indicate failure"
              $emptyXml = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="historic-basic" tests="0" failures="0" errors="1" skipped="0" time="0"><testcase name="pytest_execution_failed" classname="pytest"><error message="Pytest failed before tests could run (possibly health check or collection error)" type="ExecutionError">Pytest failed before tests could run</error></testcase></testsuite>'
              $emptyXml | Out-File -FilePath $xmlFile -Encoding utf8 -Force
              Write-Host "Created empty XML file: $xmlFile"
            } else {
              Write-Host "XML file exists: $xmlFile"
            }
            
            # Store exit code for later checking
            echo "EXIT_CODE=$exitCode" | Out-File -FilePath "reports/historic-basic-exit-code.txt" -Encoding utf8 -Force
          }
          
          exit $exitCode

      - name: Run Historic Job Tests (Heavy)
        if: ${{ inputs.load_level == 'heavy' || inputs.load_level == 'stress' }}
        id: historic-heavy
        continue-on-error: true
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          Write-Host "========================================"
          Write-Host "üìº HISTORIC JOB TESTS - HEAVY"
          Write-Host "========================================"
          
          $xmlFile = "reports/junit-historic-heavy.xml"
          $exitCode = 1  # Default to failure
          
          try {
            & $env:PYTHON_CMD -m pytest `
              be_focus_server_tests/load/test_historic_load.py `
              -m "historic and heavy" `
              --env staging `
              --skip-health-check `
              -v `
              --tb=short `
              --log-cli-level=INFO `
              --junitxml=$xmlFile 2>&1 | Tee-Object -Variable pytestOutput
            
            $exitCode = $LASTEXITCODE
            Write-Host "Pytest exit code: $exitCode"
          } catch {
            Write-Host "::error::Pytest execution failed: $_"
            $exitCode = 1
          } finally {
            if (-not (Test-Path $xmlFile)) {
              Write-Host "::warning::No XML file created - creating empty one to indicate failure"
              $emptyXml = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="historic-heavy" tests="0" failures="0" errors="1" skipped="0" time="0"><testcase name="pytest_execution_failed" classname="pytest"><error message="Pytest failed before tests could run" type="ExecutionError">Pytest failed before tests could run</error></testcase></testsuite>'
              $emptyXml | Out-File -FilePath $xmlFile -Encoding utf8 -Force
            }
            echo "EXIT_CODE=$exitCode" | Out-File -FilePath "reports/historic-heavy-exit-code.txt" -Encoding utf8 -Force
          }
          
          exit $exitCode

      - name: Run Historic Job Tests (Stress)
        if: ${{ inputs.load_level == 'stress' }}
        id: historic-stress
        continue-on-error: true
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          Write-Host "========================================"
          Write-Host "üìº HISTORIC JOB TESTS - STRESS"
          Write-Host "========================================"
          
          $xmlFile = "reports/junit-historic-stress.xml"
          $exitCode = 1  # Default to failure
          
          try {
            & $env:PYTHON_CMD -m pytest `
              be_focus_server_tests/load/test_historic_load.py `
              -m "historic and stress" `
              --env staging `
              --skip-health-check `
              -v `
              --tb=short `
              --log-cli-level=INFO `
              --junitxml=$xmlFile 2>&1 | Tee-Object -Variable pytestOutput
            
            $exitCode = $LASTEXITCODE
            Write-Host "Pytest exit code: $exitCode"
          } catch {
            Write-Host "::error::Pytest execution failed: $_"
            $exitCode = 1
          } finally {
            if (-not (Test-Path $xmlFile)) {
              Write-Host "::warning::No XML file created - creating empty one to indicate failure"
              $emptyXml = '<?xml version="1.0" encoding="UTF-8"?><testsuite name="historic-stress" tests="0" failures="0" errors="1" skipped="0" time="0"><testcase name="pytest_execution_failed" classname="pytest"><error message="Pytest failed before tests could run" type="ExecutionError">Pytest failed before tests could run</error></testcase></testsuite>'
              $emptyXml | Out-File -FilePath $xmlFile -Encoding utf8 -Force
            }
            echo "EXIT_CODE=$exitCode" | Out-File -FilePath "reports/historic-stress-exit-code.txt" -Encoding utf8 -Force
          }
          
          exit $exitCode

      - name: Generate Comprehensive Test Reports (Historic)
        if: always()
        shell: powershell
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          FOCUS_SERVER_HOST: ${{ env.FOCUS_SERVER_HOST }}
        run: |
          Write-Host "Generating comprehensive test reports for Historic Job Tests..."
          $target = "https://$env:FOCUS_SERVER_HOST/focus-server"
          
          $junitFiles = @(
            "reports/junit-historic-basic.xml",
            "reports/junit-historic-heavy.xml",
            "reports/junit-historic-stress.xml"
          )
          
          foreach ($file in $junitFiles) {
            if (Test-Path $file) {
              Write-Host "Processing: $file"
              py scripts/generate_comprehensive_test_report.py $file `
                --environment $env:ENVIRONMENT `
                --target $target
            }
          }

      - name: Check for Test Failures (Historic)
        if: always()
        shell: powershell
        run: |
          Write-Host "========================================"
          Write-Host "Checking for test failures..."
          Write-Host "========================================"
          $hasFailures = $false
          $expectedFiles = @()
          
          # Determine which test files should exist based on load_level
          $loadLevel = '${{ inputs.load_level || 'basic' }}'
          if ($loadLevel -eq 'basic' -or $loadLevel -eq '') {
            $expectedFiles += "reports/junit-historic-basic.xml"
          }
          if ($loadLevel -eq 'heavy' -or $loadLevel -eq 'stress') {
            $expectedFiles += "reports/junit-historic-heavy.xml"
          }
          if ($loadLevel -eq 'stress') {
            $expectedFiles += "reports/junit-historic-stress.xml"
          }
          
          Write-Host "Expected files for load_level '$loadLevel': $($expectedFiles -join ', ')"
          
          # Check exit codes from test steps (more reliable than step outcome with continue-on-error)
          if ($loadLevel -eq 'basic' -or $loadLevel -eq '') {
            if (Test-Path "reports/historic-basic-exit-code.txt") {
              $exitCodeLine = Get-Content "reports/historic-basic-exit-code.txt"
              if ($exitCodeLine -match "EXIT_CODE=(\d+)") {
                $exitCode = [int]$matches[1]
                Write-Host "Historic Basic exit code: $exitCode"
                if ($exitCode -ne 0) {
                  Write-Host "::error::Historic Basic tests exited with code $exitCode"
                  $hasFailures = $true
                }
              }
            } else {
              Write-Host "::warning::Exit code file not found for historic-basic (step may not have run)"
            }
          }
          
          if ($loadLevel -eq 'heavy' -or $loadLevel -eq 'stress') {
            if (Test-Path "reports/historic-heavy-exit-code.txt") {
              $exitCodeLine = Get-Content "reports/historic-heavy-exit-code.txt"
              if ($exitCodeLine -match "EXIT_CODE=(\d+)") {
                $exitCode = [int]$matches[1]
                Write-Host "Historic Heavy exit code: $exitCode"
                if ($exitCode -ne 0) {
                  Write-Host "::error::Historic Heavy tests exited with code $exitCode"
                  $hasFailures = $true
                }
              }
            }
          }
          
          if ($loadLevel -eq 'stress') {
            if (Test-Path "reports/historic-stress-exit-code.txt") {
              $exitCodeLine = Get-Content "reports/historic-stress-exit-code.txt"
              if ($exitCodeLine -match "EXIT_CODE=(\d+)") {
                $exitCode = [int]$matches[1]
                Write-Host "Historic Stress exit code: $exitCode"
                if ($exitCode -ne 0) {
                  Write-Host "::error::Historic Stress tests exited with code $exitCode"
                  $hasFailures = $true
                }
              }
            }
          }
          
          # Check if expected XML files exist
          $xmlFound = $false
          foreach ($file in $expectedFiles) {
            if (Test-Path $file) {
              $xmlFound = $true
              Write-Host "Found: $file"
              
              # Parse XML for failures/errors
              try {
                $xml = [xml](Get-Content $file)
                $testsuite = if ($xml.testsuites) { $xml.testsuites.testsuite } else { $xml.testsuite }
                
                if ($testsuite) {
                  $failures = [int]$testsuite.failures
                  $errors = [int]$testsuite.errors
                  $tests = [int]$testsuite.tests
                  
                  Write-Host "  Tests: $tests, Failures: $failures, Errors: $errors"
                  
                  if ($failures -gt 0 -or $errors -gt 0) {
                    Write-Host "::error::Found failures in $file: $failures failures, $errors errors"
                    $hasFailures = $true
                  }
                }
              } catch {
                Write-Host "::warning::Could not parse XML file $file: $_"
              }
            } else {
              Write-Host "Missing expected file: $file"
            }
          }
          
          # If no XML files were found and tests were supposed to run, that's a failure
          if (-not $xmlFound -and $expectedFiles.Count -gt 0) {
            Write-Host "::error::No JUnit XML files found - tests did not execute or failed before generating reports"
            Write-Host "Expected at least one of: $($expectedFiles -join ', ')"
            $hasFailures = $true
          }
          
          Write-Host "========================================"
          if ($hasFailures) {
            Write-Host "::error::Historic Job Tests failed - failing workflow"
            exit 1
          } else {
            Write-Host "‚úÖ All Historic Job Tests passed"
          }

      - name: Upload Historic Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: historic-job-reports
          path: reports/junit-historic-*.xml
          retention-days: 14
          if-no-files-found: warn

  # =========================================================================
  # Summary Job
  # =========================================================================
  test-summary:
    needs: [live-job-tests, historic-job-tests]
    if: always()
    runs-on: [self-hosted, windows, "panda_automation"]

    steps:
      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports/
          merge-multiple: true

      - name: Generate Comprehensive Summary Reports
        if: always()
        shell: powershell
        env:
          ENVIRONMENT: ${{ secrets.ENVIRONMENT || 'staging' }}
          FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.100' }}
        run: |
          Write-Host "Generating comprehensive summary reports..."
          $target = "https://$env:FOCUS_SERVER_HOST/focus-server"
          $testType = '${{ inputs.test_type || 'all' }}'
          $loadLevel = '${{ inputs.load_level || 'basic' }}'
          
          # Collect all JUnit XML files
          $junitFiles = Get-ChildItem -Path "all-reports" -Filter "*.xml" -Recurse -ErrorAction SilentlyContinue
          
          # Initialize summary data
          $summaryData = @{
            TotalTests = 0
            TotalPassed = 0
            TotalFailed = 0
            TotalErrors = 0
            TotalSkipped = 0
            TotalDuration = 0.0
            LiveTests = @{ Tests = 0; Passed = 0; Failed = 0; Errors = 0 }
            HistoricTests = @{ Tests = 0; Passed = 0; Failed = 0; Errors = 0 }
            Files = @()
          }
          
          if ($junitFiles) {
            Write-Host "Found $($junitFiles.Count) JUnit XML file(s)"
            
            foreach ($file in $junitFiles) {
              Write-Host "Processing: $($file.FullName)"
              
              try {
                # Generate comprehensive report for each file
                py scripts/generate_comprehensive_test_report.py $file.FullName `
                  --environment $env:ENVIRONMENT `
                  --target $target 2>&1 | Out-Null
                
                # Parse XML to collect statistics
                $xml = [xml](Get-Content $file.FullName -Raw)
                $testsuite = if ($xml.testsuites) { $xml.testsuites.testsuite } else { $xml.testsuite }
                
                if ($testsuite) {
                  $tests = [int]$testsuite.tests
                  $failures = [int]$testsuite.failures
                  $errors = [int]$testsuite.errors
                  $skipped = [int]$testsuite.skipped
                  $duration = [double]$testsuite.time
                  $passed = $tests - $failures - $errors - $skipped
                  
                  $summaryData.TotalTests += $tests
                  $summaryData.TotalPassed += $passed
                  $summaryData.TotalFailed += $failures
                  $summaryData.TotalErrors += $errors
                  $summaryData.TotalSkipped += $skipped
                  $summaryData.TotalDuration += $duration
                  
                  # Categorize by test type
                  $fileName = $file.Name
                  if ($fileName -match "live") {
                    $summaryData.LiveTests.Tests += $tests
                    $summaryData.LiveTests.Passed += $passed
                    $summaryData.LiveTests.Failed += $failures
                    $summaryData.LiveTests.Errors += $errors
                  } elseif ($fileName -match "historic") {
                    $summaryData.HistoricTests.Tests += $tests
                    $summaryData.HistoricTests.Passed += $passed
                    $summaryData.HistoricTests.Failed += $failures
                    $summaryData.HistoricTests.Errors += $errors
                  }
                  
                  $summaryData.Files += @{
                    Name = $fileName
                    Tests = $tests
                    Passed = $passed
                    Failed = $failures
                    Errors = $errors
                    Skipped = $skipped
                    Duration = $duration
                  }
                }
              } catch {
                Write-Host "::warning::Failed to process $($file.FullName): $_"
              }
            }
            
            # Generate comprehensive summary report
            $successRate = if ($summaryData.TotalTests -gt 0) { 
              [math]::Round(($summaryData.TotalPassed / $summaryData.TotalTests) * 100, 1) 
            } else { 0 }
            
            $statusEmoji = if ($summaryData.TotalFailed -eq 0 -and $summaryData.TotalErrors -eq 0) { "‚úÖ" } else { "‚ùå" }
            
            $summaryReport = @"
          # $statusEmoji Job Load Test Results
          
          ## üìã Test Execution Summary
          
          | Metric | Value |
          |--------|-------|
          | **Test Type** | $testType |
          | **Load Level** | $loadLevel |
          | **Environment** | $env:ENVIRONMENT |
          | **Target** | ``$target`` |
          | **Execution Time** | $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC') |
          
          ## üìä Overall Statistics
          
          | Metric | Value |
          |--------|-------|
          | **Total Tests** | $($summaryData.TotalTests) |
          | **‚úÖ Passed** | $($summaryData.TotalPassed) |
          | **‚ùå Failed** | $($summaryData.TotalFailed) |
          | **‚ö†Ô∏è Errors** | $($summaryData.TotalErrors) |
          | **‚è≠Ô∏è Skipped** | $($summaryData.TotalSkipped) |
          | **‚è±Ô∏è Total Duration** | $([math]::Round($summaryData.TotalDuration, 2))s |
          | **üìà Success Rate** | $successRate% |
          
          ## üî¥ Live Job Tests
          
          | Metric | Value |
          |--------|-------|
          | **Tests** | $($summaryData.LiveTests.Tests) |
          | **‚úÖ Passed** | $($summaryData.LiveTests.Passed) |
          | **‚ùå Failed** | $($summaryData.LiveTests.Failed) |
          | **‚ö†Ô∏è Errors** | $($summaryData.LiveTests.Errors) |
          
          ## üìº Historic Job Tests
          
          | Metric | Value |
          |--------|-------|
          | **Tests** | $($summaryData.HistoricTests.Tests) |
          | **‚úÖ Passed** | $($summaryData.HistoricTests.Passed) |
          | **‚ùå Failed** | $($summaryData.HistoricTests.Failed) |
          | **‚ö†Ô∏è Errors** | $($summaryData.HistoricTests.Errors) |
          
          ## üì¶ Test Files Breakdown
          
          | File | Tests | ‚úÖ Passed | ‚ùå Failed | ‚ö†Ô∏è Errors | ‚è±Ô∏è Duration |
          |------|-------|-----------|-----------|-----------|--------------|
          $(($summaryData.Files | ForEach-Object { "| ``$($_.Name)`` | $($_.Tests) | $($_.Passed) | $($_.Failed) | $($_.Errors) | $([math]::Round($_.Duration, 2))s |" }) -join "`n")
          
          ## üìù Job Status
          
          | Job | Status |
          |-----|--------|
          | **Live Job Tests** | $('${{ needs.live-job-tests.result }}') |
          | **Historic Job Tests** | $('${{ needs.historic-job-tests.result }}') |
          
          $(if ($summaryData.TotalFailed -gt 0 -or $summaryData.TotalErrors -gt 0) {
            "## ‚ö†Ô∏è Test Failures Detected
          
          The workflow detected test failures. Please review the detailed reports above and check the job logs for more information.
          
          **Next Steps:**
          1. Review the failed test cases in the detailed reports
          2. Check the job logs for error messages and stack traces
          3. Verify server connectivity and health status
          4. Review recent code changes that might have caused regressions"
          } else {
            "## ‚úÖ All Tests Passed
          
          All test cases completed successfully. The system is functioning correctly under the specified load conditions."
          })
          "@
            
            $summaryReport | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
            Write-Host "‚úÖ Comprehensive summary report generated"
            
          } else {
            Write-Host "::warning::No JUnit XML files found in all-reports/"
            
            # Generate basic summary if no files found
            $basicSummary = @"
          # ‚ö†Ô∏è Job Load Test Results
          
          ## üìã Test Execution Summary
          
          | Metric | Value |
          |--------|-------|
          | **Test Type** | $testType |
          | **Load Level** | $loadLevel |
          | **Environment** | $env:ENVIRONMENT |
          | **Target** | ``$target`` |
          | **Execution Time** | $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC') |
          
          ## ‚ö†Ô∏è Warning
          
          No test result files were found. This may indicate:
          - Tests did not execute
          - Tests failed before generating reports
          - Artifact download failed
          
          **Please check the previous job logs for details.**
          
          ## üìù Job Status
          
          | Job | Status |
          |-----|--------|
          | **Live Job Tests** | $('${{ needs.live-job-tests.result }}') |
          | **Historic Job Tests** | $('${{ needs.historic-job-tests.result }}') |
          
          ## üìö Test Types Reference
          
          | Type | Description | Markers |
          |------|-------------|---------|
          | üî¥ **Live** | Real-time streaming from fiber | ``@pytest.mark.live`` |
          | üìº **Historic** | Recorded data playback | ``@pytest.mark.historic`` |
          
          ## üìä Load Levels Reference
          
          | Level | Tests Run | Duration |
          |-------|-----------|----------|
          | **Basic** | Core functionality | ~5 min |
          | **Heavy** | 500 channels, sustained | ~15 min |
          | **Stress** | Max concurrent | ~20 min |
          "@
            $basicSummary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
            Write-Host "‚ö†Ô∏è Generated basic summary (no test files found)"
          }

      - name: Check Overall Test Results
        if: always()
        shell: powershell
        run: |
          Write-Host "Checking overall test results..."
          $hasFailures = $false
          $totalTests = 0
          $totalFailures = 0
          $totalErrors = 0
          
          # Check job outcomes
          $liveJobFailed = '${{ needs.live-job-tests.result }}' -eq 'failure'
          $historicJobFailed = '${{ needs.historic-job-tests.result }}' -eq 'failure'
          
          if ($liveJobFailed) {
            Write-Host "::error::Live Job Tests job failed"
            $hasFailures = $true
          }
          
          if ($historicJobFailed) {
            Write-Host "::error::Historic Job Tests job failed"
            $hasFailures = $true
          }
          
          # Parse all JUnit files
          $junitFiles = Get-ChildItem -Path "all-reports" -Filter "*.xml" -Recurse -ErrorAction SilentlyContinue
          
          foreach ($file in $junitFiles) {
            $xml = [xml](Get-Content $file.FullName)
            $ts = if ($xml.testsuites) { $xml.testsuites.testsuite } else { $xml.testsuite }
            
            if ($ts) {
              $totalTests += [int]$ts.tests
              $totalFailures += [int]$ts.failures
              $totalErrors += [int]$ts.errors
            }
          }
          
          Write-Host "Summary: $totalTests tests, $totalFailures failures, $totalErrors errors"
          
          if ($totalFailures -gt 0 -or $totalErrors -gt 0) {
            Write-Host "::error::Test failures detected: $totalFailures failures, $totalErrors errors"
            $hasFailures = $true
          }
          
          if ($hasFailures) {
            Write-Host "::error::Overall test results indicate failures - failing workflow"
            exit 1
          } else {
            Write-Host "‚úÖ All tests passed successfully"
          }

