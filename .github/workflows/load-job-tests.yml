name: Job Load Tests (Live & Historic)

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: "Test type to run"
        type: choice
        options:
          - all
          - live
          - historic
        default: "all"
      load_level:
        description: "Load level"
        type: choice
        options:
          - basic
          - heavy
          - stress
        default: "basic"
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  pull_request:
    branches: [main]
    paths:
      - 'be_focus_server_tests/load/**'
      - 'src/apis/grpc_client.py'
      - 'src/apis/focus_server_api.py'

env:
  PYTHON_VERSION: '3.13'

jobs:
  # =========================================================================
  # Live Job Tests
  # =========================================================================
  live-job-tests:
    if: ${{ inputs.test_type == 'all' || inputs.test_type == 'live' || inputs.test_type == '' }}
    runs-on: [self-hosted, windows, "panda_automation"]
    timeout-minutes: 20

    env:
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.100' }}
      VERIFY_SSL: 'false'
      ENVIRONMENT: 'staging'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        shell: powershell
        run: |
          $pythonCmd = if ((py --version 2>&1) -match "Python") { "py" } else { "python" }
          echo "PYTHON_CMD=$pythonCmd" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Install dependencies
        shell: powershell
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\install_dependencies.ps1
          & $env:PYTHON_CMD -m pip install -e . --quiet

      - name: Health Check
        shell: powershell
        run: |
          $url = "https://$env:FOCUS_SERVER_HOST/focus-server/ack"
          $result = curl.exe -k -s -w "%{http_code}" -o nul $url 2>&1
          if ($result -ne "200") { exit 1 }
          Write-Host "Server OK"

      - name: Run Live Job Tests (Basic)
        if: ${{ inputs.load_level == 'basic' || inputs.load_level == '' }}
        id: live-basic
        continue-on-error: true
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          Write-Host "========================================"
          Write-Host "üî¥ LIVE JOB TESTS - BASIC"
          Write-Host "========================================"
          
          & $env:PYTHON_CMD -m pytest `
            be_focus_server_tests/load/test_live_load.py `
            -m "live and not heavy and not stress" `
            --env staging `
            --skip-health-check `
            -v `
            --tb=short `
            --log-cli-level=INFO `
            --junitxml=reports/junit-live-basic.xml
          
          exit $LASTEXITCODE

      - name: Run Live Job Tests (Heavy)
        if: ${{ inputs.load_level == 'heavy' || inputs.load_level == 'stress' }}
        id: live-heavy
        continue-on-error: true
        shell: powershell
        run: |
          Write-Host "========================================"
          Write-Host "üî¥ LIVE JOB TESTS - HEAVY"
          Write-Host "========================================"
          
          & $env:PYTHON_CMD -m pytest `
            be_focus_server_tests/load/test_live_load.py `
            -m "live and heavy" `
            --env staging `
            --skip-health-check `
            -v `
            --tb=short `
            --log-cli-level=INFO `
            --junitxml=reports/junit-live-heavy.xml
          
          exit $LASTEXITCODE

      - name: Run Live Job Tests (Stress)
        if: ${{ inputs.load_level == 'stress' }}
        id: live-stress
        continue-on-error: true
        shell: powershell
        run: |
          Write-Host "========================================"
          Write-Host "üî¥ LIVE JOB TESTS - STRESS"
          Write-Host "========================================"
          
          & $env:PYTHON_CMD -m pytest `
            be_focus_server_tests/load/test_live_load.py `
            -m "live and stress" `
            --env staging `
            --skip-health-check `
            -v `
            --tb=short `
            --log-cli-level=INFO `
            --junitxml=reports/junit-live-stress.xml
          
          exit $LASTEXITCODE

      - name: Generate Comprehensive Test Reports (Live)
        if: always()
        shell: powershell
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          FOCUS_SERVER_HOST: ${{ env.FOCUS_SERVER_HOST }}
        run: |
          Write-Host "Generating comprehensive test reports for Live Job Tests..."
          $target = "https://$env:FOCUS_SERVER_HOST/focus-server"
          
          $junitFiles = @(
            "reports/junit-live-basic.xml",
            "reports/junit-live-heavy.xml",
            "reports/junit-live-stress.xml"
          )
          
          foreach ($file in $junitFiles) {
            if (Test-Path $file) {
              Write-Host "Processing: $file"
              py scripts/generate_comprehensive_test_report.py $file `
                --environment $env:ENVIRONMENT `
                --target $target
            }
          }

      - name: Check for Test Failures (Live)
        if: always()
        shell: powershell
        run: |
          Write-Host "Checking for test failures..."
          $hasFailures = $false
          $junitFiles = @(
            "reports/junit-live-basic.xml",
            "reports/junit-live-heavy.xml",
            "reports/junit-live-stress.xml"
          )
          
          foreach ($file in $junitFiles) {
            if (Test-Path $file) {
              $xml = [xml](Get-Content $file)
              $testsuite = if ($xml.testsuites) { $xml.testsuites.testsuite } else { $xml.testsuite }
              
              if ($testsuite) {
                $failures = [int]$testsuite.failures
                $errors = [int]$testsuite.errors
                
                if ($failures -gt 0 -or $errors -gt 0) {
                  Write-Host "::error::Found failures in $file: $failures failures, $errors errors"
                  $hasFailures = $true
                }
              }
            }
          }
          
          # Also check step outcomes
          $basicFailed = '${{ steps.live-basic.outcome }}' -eq 'failure'
          $heavyFailed = '${{ steps.live-heavy.outcome }}' -eq 'failure'
          $stressFailed = '${{ steps.live-stress.outcome }}' -eq 'failure'
          
          if ($basicFailed -or $heavyFailed -or $stressFailed) {
            Write-Host "::error::One or more test steps failed"
            $hasFailures = $true
          }
          
          # Check if no XML files were generated (tests didn't run)
          $xmlFound = $false
          foreach ($file in $junitFiles) {
            if (Test-Path $file) {
              $xmlFound = $true
              break
            }
          }
          
          if (-not $xmlFound) {
            Write-Host "::error::No JUnit XML files found - tests may not have executed"
            $hasFailures = $true
          }
          
          if ($hasFailures) {
            Write-Host "::error::Live Job Tests failed - failing workflow"
            exit 1
          } else {
            Write-Host "‚úÖ All Live Job Tests passed"
          }

      - name: Upload Live Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: live-job-reports
          path: reports/junit-live-*.xml
          retention-days: 14
          if-no-files-found: warn

  # =========================================================================
  # Historic Job Tests
  # =========================================================================
  historic-job-tests:
    if: ${{ inputs.test_type == 'all' || inputs.test_type == 'historic' || inputs.test_type == '' }}
    runs-on: [self-hosted, windows, "panda_automation"]
    timeout-minutes: 25

    env:
      FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.100' }}
      VERIFY_SSL: 'false'
      ENVIRONMENT: 'staging'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        shell: powershell
        run: |
          $pythonCmd = if ((py --version 2>&1) -match "Python") { "py" } else { "python" }
          echo "PYTHON_CMD=$pythonCmd" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Install dependencies
        shell: powershell
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\install_dependencies.ps1
          & $env:PYTHON_CMD -m pip install -e . --quiet

      - name: Health Check
        shell: powershell
        run: |
          $url = "https://$env:FOCUS_SERVER_HOST/focus-server/ack"
          $result = curl.exe -k -s -w "%{http_code}" -o nul $url 2>&1
          if ($result -ne "200") { exit 1 }
          Write-Host "Server OK"

      - name: Run Historic Job Tests (Basic)
        if: ${{ inputs.load_level == 'basic' || inputs.load_level == '' }}
        id: historic-basic
        continue-on-error: true
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path reports | Out-Null
          
          Write-Host "========================================"
          Write-Host "üìº HISTORIC JOB TESTS - BASIC"
          Write-Host "========================================"
          
          & $env:PYTHON_CMD -m pytest `
            be_focus_server_tests/load/test_historic_load.py `
            -m "historic and not heavy and not stress" `
            --env staging `
            --skip-health-check `
            -v `
            --tb=short `
            --log-cli-level=INFO `
            --junitxml=reports/junit-historic-basic.xml
          
          exit $LASTEXITCODE

      - name: Run Historic Job Tests (Heavy)
        if: ${{ inputs.load_level == 'heavy' || inputs.load_level == 'stress' }}
        id: historic-heavy
        continue-on-error: true
        shell: powershell
        run: |
          Write-Host "========================================"
          Write-Host "üìº HISTORIC JOB TESTS - HEAVY"
          Write-Host "========================================"
          
          & $env:PYTHON_CMD -m pytest `
            be_focus_server_tests/load/test_historic_load.py `
            -m "historic and heavy" `
            --env staging `
            --skip-health-check `
            -v `
            --tb=short `
            --log-cli-level=INFO `
            --junitxml=reports/junit-historic-heavy.xml
          
          exit $LASTEXITCODE

      - name: Run Historic Job Tests (Stress)
        if: ${{ inputs.load_level == 'stress' }}
        id: historic-stress
        continue-on-error: true
        shell: powershell
        run: |
          Write-Host "========================================"
          Write-Host "üìº HISTORIC JOB TESTS - STRESS"
          Write-Host "========================================"
          
          & $env:PYTHON_CMD -m pytest `
            be_focus_server_tests/load/test_historic_load.py `
            -m "historic and stress" `
            --env staging `
            --skip-health-check `
            -v `
            --tb=short `
            --log-cli-level=INFO `
            --junitxml=reports/junit-historic-stress.xml
          
          exit $LASTEXITCODE

      - name: Generate Comprehensive Test Reports (Historic)
        if: always()
        shell: powershell
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          FOCUS_SERVER_HOST: ${{ env.FOCUS_SERVER_HOST }}
        run: |
          Write-Host "Generating comprehensive test reports for Historic Job Tests..."
          $target = "https://$env:FOCUS_SERVER_HOST/focus-server"
          
          $junitFiles = @(
            "reports/junit-historic-basic.xml",
            "reports/junit-historic-heavy.xml",
            "reports/junit-historic-stress.xml"
          )
          
          foreach ($file in $junitFiles) {
            if (Test-Path $file) {
              Write-Host "Processing: $file"
              py scripts/generate_comprehensive_test_report.py $file `
                --environment $env:ENVIRONMENT `
                --target $target
            }
          }

      - name: Check for Test Failures (Historic)
        if: always()
        shell: powershell
        run: |
          Write-Host "Checking for test failures..."
          $hasFailures = $false
          $junitFiles = @(
            "reports/junit-historic-basic.xml",
            "reports/junit-historic-heavy.xml",
            "reports/junit-historic-stress.xml"
          )
          
          foreach ($file in $junitFiles) {
            if (Test-Path $file) {
              $xml = [xml](Get-Content $file)
              $testsuite = if ($xml.testsuites) { $xml.testsuites.testsuite } else { $xml.testsuite }
              
              if ($testsuite) {
                $failures = [int]$testsuite.failures
                $errors = [int]$testsuite.errors
                
                if ($failures -gt 0 -or $errors -gt 0) {
                  Write-Host "::error::Found failures in $file: $failures failures, $errors errors"
                  $hasFailures = $true
                }
              }
            }
          }
          
          # Also check step outcomes
          $basicFailed = '${{ steps.historic-basic.outcome }}' -eq 'failure'
          $heavyFailed = '${{ steps.historic-heavy.outcome }}' -eq 'failure'
          $stressFailed = '${{ steps.historic-stress.outcome }}' -eq 'failure'
          
          if ($basicFailed -or $heavyFailed -or $stressFailed) {
            Write-Host "::error::One or more test steps failed"
            $hasFailures = $true
          }
          
          # Check if no XML files were generated (tests didn't run)
          $xmlFound = $false
          foreach ($file in $junitFiles) {
            if (Test-Path $file) {
              $xmlFound = $true
              break
            }
          }
          
          if (-not $xmlFound) {
            Write-Host "::error::No JUnit XML files found - tests may not have executed"
            $hasFailures = $true
          }
          
          if ($hasFailures) {
            Write-Host "::error::Historic Job Tests failed - failing workflow"
            exit 1
          } else {
            Write-Host "‚úÖ All Historic Job Tests passed"
          }

      - name: Upload Historic Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: historic-job-reports
          path: reports/junit-historic-*.xml
          retention-days: 14
          if-no-files-found: warn

  # =========================================================================
  # Summary Job
  # =========================================================================
  test-summary:
    needs: [live-job-tests, historic-job-tests]
    if: always()
    runs-on: [self-hosted, windows, "panda_automation"]

    steps:
      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports/
          merge-multiple: true

      - name: Generate Comprehensive Summary Reports
        if: always()
        shell: powershell
        env:
          ENVIRONMENT: ${{ secrets.ENVIRONMENT || 'staging' }}
          FOCUS_SERVER_HOST: ${{ secrets.FOCUS_SERVER_HOST || '10.10.10.100' }}
        run: |
          Write-Host "Generating comprehensive summary reports..."
          $target = "https://$env:FOCUS_SERVER_HOST/focus-server"
          
          # Generate comprehensive reports for each JUnit XML file
          $junitFiles = Get-ChildItem -Path "all-reports" -Filter "*.xml" -Recurse -ErrorAction SilentlyContinue
          
          if ($junitFiles) {
            foreach ($file in $junitFiles) {
              Write-Host "Processing: $($file.FullName)"
              py scripts/generate_comprehensive_test_report.py $file.FullName `
                --environment $env:ENVIRONMENT `
                --target $target
            }
          } else {
            Write-Host "::warning::No JUnit XML files found in all-reports/"
            
            # Generate basic summary if no files found
            $basicSummary = @"
          # üöÄ Job Load Test Results
          
          **Test Type:** ${{ inputs.test_type || 'all' }}
          **Load Level:** ${{ inputs.load_level || 'basic' }}
          **Time:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          
          ## ‚ö†Ô∏è Warning
          
          No test result files were found. This may indicate:
          - Tests did not execute
          - Tests failed before generating reports
          - Artifact download failed
          
          Check the previous job logs for details.
          
          ## Test Types
          
          | Type | Description | Markers |
          |------|-------------|---------|
          | üî¥ **Live** | Real-time streaming from fiber | ``@pytest.mark.live`` |
          | üìº **Historic** | Recorded data playback | ``@pytest.mark.historic`` |
          
          ## Load Levels
          
          | Level | Tests Run | Duration |
          |-------|-----------|----------|
          | Basic | Core functionality | ~5 min |
          | Heavy | 500 channels, sustained | ~15 min |
          | Stress | Max concurrent | ~20 min |
          "@
            $basicSummary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          }

      - name: Check Overall Test Results
        if: always()
        shell: powershell
        run: |
          Write-Host "Checking overall test results..."
          $hasFailures = $false
          $totalTests = 0
          $totalFailures = 0
          $totalErrors = 0
          
          # Check job outcomes
          $liveJobFailed = '${{ needs.live-job-tests.result }}' -eq 'failure'
          $historicJobFailed = '${{ needs.historic-job-tests.result }}' -eq 'failure'
          
          if ($liveJobFailed) {
            Write-Host "::error::Live Job Tests job failed"
            $hasFailures = $true
          }
          
          if ($historicJobFailed) {
            Write-Host "::error::Historic Job Tests job failed"
            $hasFailures = $true
          }
          
          # Parse all JUnit files
          $junitFiles = Get-ChildItem -Path "all-reports" -Filter "*.xml" -Recurse -ErrorAction SilentlyContinue
          
          foreach ($file in $junitFiles) {
            $xml = [xml](Get-Content $file.FullName)
            $ts = if ($xml.testsuites) { $xml.testsuites.testsuite } else { $xml.testsuite }
            
            if ($ts) {
              $totalTests += [int]$ts.tests
              $totalFailures += [int]$ts.failures
              $totalErrors += [int]$ts.errors
            }
          }
          
          Write-Host "Summary: $totalTests tests, $totalFailures failures, $totalErrors errors"
          
          if ($totalFailures -gt 0 -or $totalErrors -gt 0) {
            Write-Host "::error::Test failures detected: $totalFailures failures, $totalErrors errors"
            $hasFailures = $true
          }
          
          if ($hasFailures) {
            Write-Host "::error::Overall test results indicate failures - failing workflow"
            exit 1
          } else {
            Write-Host "‚úÖ All tests passed successfully"
          }

