name: Panda Tests

on:
  workflow_dispatch:
    inputs:
      marker:
        description: "pytest marker to run (e.g., smoke, regression). Leave empty to run all."
        required: false
        default: ""

jobs:
  test:
    runs-on: [self-hosted, windows, "panda_automation"]
    permissions:
      checks: write
      pull-requests: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.13.9"]
        # If a marker was provided via workflow_dispatch, we use just that.
        # Otherwise, run a matrix of common categories.
        include:
          - python-version: "3.13.9"
            marker: ${{ github.event.inputs.marker }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        shell: powershell
        run: |
          $ErrorActionPreference = 'Continue'
          # Use existing Python installation instead of setup-python to avoid registry permission issues
          $pythonVersion = py --version 2>&1 | Select-String -Pattern "Python (\d+\.\d+)" | ForEach-Object { $_.Matches[0].Groups[1].Value }
          if ($pythonVersion) {
            Write-Host "Found Python $pythonVersion via py launcher"
            # Get Python path and Scripts directory
            $pythonPath = py -c "import sys; print(sys.executable)" 2>&1
            if ($pythonPath -and -not ($pythonPath -match "Error|Exception")) {
              $pythonDir = Split-Path $pythonPath
              $scriptsDir = Join-Path $pythonDir "Scripts"
              
              # Use GITHUB_PATH to persist PATH across steps
              if ($env:GITHUB_PATH) {
                echo "$pythonDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                echo "$scriptsDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
              }
              
              Write-Host "Python path: $pythonPath"
              Write-Host "Scripts path: $scriptsDir"
            } else {
              Write-Host "Warning: Could not get Python path, but py launcher works"
            }
          } else {
            Write-Host "Python not found via py launcher, trying python directly..."
            # Try to find python in common locations
            $pythonPaths = @(
              "C:\Python*",
              "C:\Program Files\Python*",
              "C:\Users\$env:USERNAME\AppData\Local\Programs\Python\Python*"
            )
            foreach ($pathPattern in $pythonPaths) {
              $foundPython = Get-ChildItem -Path $pathPattern -Filter "python.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($foundPython) {
                $pythonDir = Split-Path $foundPython.FullName
                $scriptsDir = Join-Path $pythonDir "Scripts"
                
                # Use GITHUB_PATH to persist PATH across steps
                if ($env:GITHUB_PATH) {
                  echo "$pythonDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                  echo "$scriptsDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                }
                
                Write-Host "Found Python at: $($foundPython.FullName)"
                break
              }
            }
          }
          # Verify Python is accessible (use py launcher which is always in PATH)
          Write-Host "Verifying Python access:"
          py --version
          $pipResult = py -m pip --version 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Warning: pip not accessible via py -m pip, but continuing..."
            Write-Host "pip output: $pipResult"
          } else {
            Write-Host "pip is accessible"
          }

      - name: Install deps
        shell: powershell
        run: |
          # Use py launcher which is always in PATH, or python if PATH was set correctly
          py -m ensurepip --upgrade
          py -m pip install --upgrade pip
          if (Test-Path requirements.txt) {
            py -m pip install -r requirements.txt
          }
          py -m pip install pytest pytest-cov requests

      - name: Install project in editable mode
        shell: powershell
        run: |
          Write-Host "Installing project in editable mode..."
          py -m pip install -e .
          if ($LASTEXITCODE -ne 0) {
            Write-Host "::warning::Failed to install project in editable mode, continuing anyway..."
          } else {
            Write-Host "Project installed successfully"
          }

      - name: Verify Python and pytest installation
        shell: powershell
        run: |
          where.exe py
          py --version
          # Verify pytest is installed (check if it can be imported, not run)
          # This avoids loading conftest.py which requires external module
          py -c "import pytest; print(f'pytest {pytest.__version__}')"

      - name: Run tests (all or by marker)
        shell: powershell
        continue-on-error: true
        env:
          MARKER: ${{ matrix.marker || github.event.inputs.marker || '' }}
        run: |
          if (-not (Test-Path test-results)) {
            New-Item -ItemType Directory -Path test-results | Out-Null
          }
          # Safely get marker value, handling null/empty cases
          $marker = if ($env:MARKER) { $env:MARKER.Trim() } else { "" }
          if ($marker -ne "" -and $marker -ne "null" -and $null -ne $marker) {
            Write-Host "Running only marker: $marker"
            py -m pytest be_focus_server_tests/ `
              -m "$marker" `
              --ignore=be_focus_server_tests/ui `
              -v `
              --junitxml=test-results\junit-$marker.xml `
              --cov=be_focus_server_tests `
              --cov-report=term-missing
          } else {
            Write-Host "Running smoke tests (default when no marker specified)"
            py -m pytest be_focus_server_tests/ `
              -m "smoke" `
              --ignore=be_focus_server_tests/ui `
              -v `
              --maxfail=10 `
              --junitxml=test-results\junit-smoke.xml `
              --cov=be_focus_server_tests `
              --cov-report=term-missing
          }

      - name: List test result files
        shell: powershell
        if: always()
        run: |
          Write-Host "Checking for test result files:"
          if (Test-Path test-results\*.xml) {
            Write-Host "Files found!"
            Get-ChildItem test-results\*.xml | ForEach-Object { Write-Host "Found: $($_.FullName)" }
          } else {
            Write-Host "No XML files found in test-results"
          }

      - name: Publish Test Results
        id: test-reporter
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Pytest Results
          path: test-results/junit-*.xml
          path-replace-backslashes: true
          reporter: java-junit
          list-suites: all
          list-tests: all
          max-annotations: 50
          fail-on-error: false
          only-summary: false
          working-directory: ${{ github.workspace }}

      - name: Get Check Run ID
        id: get-check-run
        if: always()
        shell: powershell
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Getting check run ID for 'Pytest Results'..."
          # Try multiple times with increasing delays (check run may not be created immediately)
          $maxAttempts = 3
          $checkRunId = ""
          $finalExitCode = 1
          
          for ($attempt = 1; $attempt -le $maxAttempts; $attempt++) {
              if ($attempt -gt 1) {
                  $delay = ($attempt - 1) * 3
                  Write-Host "Retry attempt $attempt after $delay seconds..."
                  Start-Sleep -Seconds $delay
              } else {
                  Write-Host "Initial attempt, waiting 5 seconds for check run to be created..."
                  Start-Sleep -Seconds 5
              }
              
              # Use single-line Python command (matches working workflows exactly)
              # Note: This will exit with code 1 if API call fails, but we handle that in PowerShell
              $ErrorActionPreference = 'Continue'
              # Escape single quotes in Python command by using double quotes for Python strings where possible
              $pythonCmd = 'import requests, json, os, time; repo = os.environ["GITHUB_REPOSITORY"]; sha = os.environ.get("GITHUB_SHA", ""); token = os.environ["GITHUB_TOKEN"]; headers = {"Authorization": f"Bearer {token}", "Accept": "application/vnd.github.v3+json"}; url = f"https://api.github.com/repos/{repo}/commits/{sha}/check-runs"; params = {"check_name": "Pytest Results", "filter": "latest"}; r = requests.get(url, headers=headers, params=params); data = r.json(); check_runs = data.get("check_runs", []); check_run_id = str(check_runs[0].get("id", "")) if check_runs else ""; print(check_run_id)'
              $output = py -c $pythonCmd 2>&1
              $exitCode = $LASTEXITCODE
              
              Write-Host "Attempt $attempt - Exit code: $exitCode"
              Write-Host "Output: $output"
              
              # Extract numeric ID from output (handle both string and array)
              $cleanOutput = ""
              if ($output) {
                  $outputArray = @()
                  if ($output -is [System.Array]) {
                      $outputArray = $output
                  } else {
                      $outputArray = @($output)
                  }
                  
                  foreach ($line in $outputArray) {
                      $lineStr = $line.ToString().Trim()
                      # Match only pure numeric strings (the check run ID)
                      if ($lineStr -match '^\d+$' -and $lineStr.Length -gt 0) {
                          $cleanOutput = $lineStr
                          break
                      }
                  }
              }
              
              if ($exitCode -eq 0 -and $cleanOutput -and $cleanOutput -match '^\d+$') {
                  $checkRunId = $cleanOutput
                  $finalExitCode = 0
                  Write-Host "Successfully retrieved check run ID: $checkRunId"
                  break
              } else {
                  Write-Host "Check run ID not found in attempt $attempt"
              }
          }
          
          # Always set output, even if empty (so next step doesn't fail)
          if ($checkRunId -and $checkRunId -match '^\d+$') {
              Write-Host "✓ CHECK_RUN_ID=$checkRunId"
              echo "id=$checkRunId" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
              Write-Host "⚠ CHECK_RUN_ID= (not found after $maxAttempts attempts - this is OK, workflow will continue)"
              echo "id=" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          }
          
          # Always exit with success so workflow continues even if check run not found
          exit 0

      - name: Parse and Display Test Results
        if: always()
        shell: powershell
        env:
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          CHECK_RUN_ID: ${{ steps.get-check-run.outputs.id }}
        run: |
          py parse_junit_results.py

      - uses: actions/upload-artifact@v4
        with:
          name: junit-reports
          path: test-results\*.xml
          if-no-files-found: warn

